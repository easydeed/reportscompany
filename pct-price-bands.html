<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>PCT ‚Ä¢ Price Bands Analysis</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>

  /* ====== Print Setup ====== */
  @page {
    size: letter;
    margin: 0.2in;
  }
  @media print {
    @page {
      margin: 0.2in;
      size: Letter;
    }
    html, body { 
      background: #fff !important; 
      margin: 0 !important;
      padding: 0 !important;
    }
    .page { 
      box-shadow: none !important; 
      width: 100% !important;
      min-height: auto !important;
      margin: 0 !important;
      padding: 0.15in !important;
    }
    
    /* Adjust spacing in print mode for better fit */
    .ribbon {
      margin: 6px 0 14px !important;
      padding: 14px 18px !important;
    }
    .insight-box {
      margin-bottom: 14px !important;
    }
    .summary-grid {
      margin-bottom: 14px !important;
    }
    .card {
      margin-bottom: 16px !important;
    }
    
    /* Header logo section - repeat on each page */
    .header-logo {
      page-break-before: avoid;
      page-break-after: avoid;
    }
    
    /* Ribbon section - keep on first page */
    .ribbon {
      page-break-after: avoid;
      page-break-inside: avoid;
    }
    
    /* Cards - allow natural breaks */
    .card {
      page-break-inside: auto;
    }
    
    /* Footer - appears at bottom of each page */
    .employee-footer {
      page-break-inside: avoid;
      page-break-before: auto;
      margin-top: 20px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px 0.2in;
      background: #fff;
      border-top: 2px solid #e5e7eb;
    }
    
    /* Add bottom padding to content area to account for fixed footer */
    .page {
      padding-bottom: 140px !important; /* Space for footer so bands don't hide behind it */
    }
    
    /* Ensure bands container has bottom margin */
    #bands-container {
      margin-bottom: 120px;
    }
    
    /* Price band sections - prevent breaks within bands and add spacing */
    .price-band {
      page-break-inside: avoid;
      break-inside: avoid;
      margin-bottom: 24px !important;
      padding-bottom: 24px !important;
    }
    
    a { color: inherit; text-decoration: none; }
    .no-print { display: none !important; }
    .avoid-break { break-inside: avoid; page-break-inside: avoid; }
    * { 
      -webkit-print-color-adjust: exact; 
      print-color-adjust: exact; 
    }
  }

  html, body {
    height: 100%;
    margin: 0;
    background: #f3f4f6;
    font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: #111827;
  }

  :root{
    --pct-blue: rgb(37,99,235);
    --pct-gray: rgb(247,249,252);
    --pct-accent: #f26b2b;
    --ink: #0f172a;
    --muted: #6b7280;
    --border: #e5e7eb;
    --success: #16a34a;
    --danger: #dc2626;
  }

  .page{
    width: 8.5in;
    min-height: 11in;
    box-sizing: border-box;
    margin: 0 auto;
    background: white;
    box-shadow: 0 2px 24px rgba(0,0,0,.06);
    padding: 0.5in;
  }

  .header{
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
    margin-bottom: 14px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .brand img{ height: 44px; width: auto; display:block; }
  .title-block h1{
    font-size: 22px; line-height:1.2; margin:0; color: var(--ink);
    letter-spacing: .2px;
  }
  .title-block .sub{ margin-top: 2px; font-size: 12px; color: var(--muted); }
  .badge{
    background: var(--pct-blue); color: #fff; 
    padding: 8px 12px; border-radius: 999px; font-weight: 600; font-size: 12px;
  }

  .ribbon{
    background: linear-gradient(90deg, var(--pct-blue), var(--pct-accent));
    color: #fff; border-radius: 14px;
    padding: 14px 18px; margin: 6px 0 16px;
    display:grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
  }
  .ribbon .kpi{ display:flex; gap: 24px; flex-wrap: nowrap; }
  .ribbon .kpi .item{ min-width: 120px; }
  .ribbon .kpi .lbl{ font-size: 11px; opacity:.9; letter-spacing:.3px; }
  .ribbon .kpi .val{ font-size: 20px; font-weight: 700; line-height:1.1; }

  .card{
    background: #fff; border: 1px solid var(--border);
    border-radius: 14px; padding: 16px 18px;
    margin-bottom: 16px;
  }
  .card h3{
    margin: 0 0 12px; font-size: 13px; letter-spacing:.2px; color: var(--muted);
    text-transform: uppercase;
  }

  .insight-box {
    background: #f0f9ff;
    border-left: 4px solid var(--pct-blue);
    padding: 12px 16px;
    margin-bottom: 16px;
    border-radius: 8px;
  }
  .insight-box h4 {
    margin: 0 0 6px;
    font-size: 13px;
    color: var(--pct-blue);
    font-weight: 700;
  }
  .insight-box p {
    margin: 0;
    font-size: 12px;
    color: #0c4a6e;
    line-height: 1.5;
  }

  .price-band {
    margin-bottom: 28px;
    padding-bottom: 28px;
    border-bottom: 1px solid var(--border);
  }
  .price-band:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .band-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .band-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--ink);
  }
  .band-count {
    font-size: 14px;
    color: var(--muted);
    background: var(--pct-gray);
    padding: 4px 12px;
    border-radius: 999px;
    font-weight: 600;
  }
  
  .band-visual {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }
  .bar-container {
    flex: 1;
    height: 32px;
    background: #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
  }
  .bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--pct-blue), var(--pct-accent));
    border-radius: 8px;
    display: flex;
    align-items: center;
    padding-left: 12px;
    color: white;
    font-weight: 700;
    font-size: 13px;
    transition: width 0.4s ease;
  }
  .bar-percent {
    min-width: 60px;
    text-align: right;
    font-weight: 700;
    color: var(--ink);
    font-size: 14px;
  }
  
  .band-metrics {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-top: 12px;
  }
  .metric-item {
    background: var(--pct-gray);
    padding: 10px 12px;
    border-radius: 8px;
  }
  .metric-label {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 4px;
  }
  .metric-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--ink);
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  .summary-card {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    color: white;
    padding: 16px;
    border-radius: 12px;
  }
  .summary-card.accent {
    background: linear-gradient(135deg, #c2410c 0%, #f97316 100%);
  }
  .summary-label {
    font-size: 11px;
    opacity: 0.9;
    margin-bottom: 4px;
  }
  .summary-value {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .summary-note {
    font-size: 10px;
    opacity: 0.8;
  }

  .footer{ margin-top: 20px; display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
  .foot-notes{ font-size: 10.5px; color: #6b7280; }
  .brandbar{ display:flex; gap: 10px; align-items:center; }
  .brandbar .dot{ width:10px; height:10px; border-radius:999px; background: var(--pct-blue); }
  .brandbar .dot.acc{ background: var(--pct-accent); }
  .brandbar .tag{ font-weight: 800; letter-spacing: .4px; color: #111827; font-size: 11px; }

  /* Action buttons */
  .action-buttons {
    position: fixed; top: 20px; right: 20px; 
    display: flex; gap: 10px; z-index: 1000;
  }
  .print-btn, .social-btn{
    background: var(--pct-blue); color: #fff; border: none;
    padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 14px;
    cursor: pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    transition: all 0.2s;
  }
  .print-btn:hover, .social-btn:hover{
    background: var(--pct-accent); transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(242,107,43,0.4);
  }
  .social-btn {
    background: #10b981;
    box-shadow: 0 4px 12px rgba(16,185,129,0.3);
  }
  .social-btn:hover {
    background: #059669;
    box-shadow: 0 6px 16px rgba(5,150,105,0.4);
  }
  @media print {
    .action-buttons { display: none; }
  }
  
  /* Social Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: white;
    border-radius: 16px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow: auto;
    padding: 30px;
    position: relative;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .modal-header h2 {
    margin: 0;
    color: #111827;
  }
  .modal-close {
    background: #ef4444;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    line-height: 1;
  }
  .modal-body {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
    align-items: start;
  }
  .preview-container {
    background: #f3f4f6;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .preview-frame {
    width: 270px;
    height: 480px;
    border: 3px solid #111827;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  }
  .preview-frame iframe {
    width: 1080px;
    height: 1920px;
    border: none;
    transform: scale(0.25);
    transform-origin: 0 0;
  }
  .controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .control-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #374151;
    font-size: 14px;
  }
  .control-group select {
    width: 100%;
    padding: 10px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
  }
  .download-btn {
    background: var(--pct-blue);
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s;
  }
  .download-btn:hover {
    background: var(--pct-accent);
    transform: translateY(-2px);
  }
  .download-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }
  
  /* Checkbox list for price bands */
  .checkbox-list {
    max-height: 300px;
    overflow-y: auto;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
  }
  .checkbox-item {
    display: flex;
    align-items: center;
    padding: 8px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.2s;
  }
  .checkbox-item:hover {
    background: #f3f4f6;
  }
  .checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 10px;
    cursor: pointer;
  }
  .checkbox-item input[type="checkbox"]:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }
  .checkbox-item label {
    cursor: pointer;
    font-size: 14px;
    color: #374151;
    flex: 1;
    margin: 0;
  }
  .checkbox-item.disabled {
    opacity: 0.5;
  }
  .selection-counter {
    font-size: 13px;
    color: #6b7280;
    margin-top: 8px;
    font-weight: 600;
  }
  .selection-counter.max {
    color: #dc2626;
  }

</style>
</head>
<body>
  <!-- Action Buttons -->
  <div class="action-buttons no-print">
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
    <button class="social-btn" onclick="openSocialModal()">üì± Generate Social Graphic</button>
  </div>

  <!-- Social Modal -->
  <div id="socialModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì± Generate Social Graphic</h2>
        <button class="modal-close" onclick="closeSocialModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="preview-container">
          <div class="preview-frame">
            <iframe id="socialPreview" src=""></iframe>
          </div>
        </div>
        <div class="controls">
          <div class="control-group">
            <label>Select Price Bands (Max 4)</label>
            <div class="checkbox-list" id="bandCheckboxList">
              <!-- Checkboxes will be dynamically inserted here -->
            </div>
            <div class="selection-counter" id="selectionCounter">Selected: 0/4</div>
          </div>
          <div class="control-group">
            <label for="themeSelect">Background Theme</label>
            <select id="themeSelect" onchange="updatePreview()">
              <option value="">Sunset Wave (Default)</option>
              <option value="classic">Classic Gradient</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </div>
          <div class="control-group">
            <label>Preview Size</label>
            <p style="margin: 0; font-size: 13px; color: #6b7280;">1080 √ó 1920 (Instagram/Facebook Story)</p>
          </div>
          <button class="download-btn" onclick="downloadSocialGraphic()" id="downloadBtn">
            <span id="downloadText">üì• Download PNG (300 DPI - 4320√ó7680)</span>
          </button>
          <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">
            Print-quality 300 DPI output ‚Ä¢ Perfect for Instagram/Facebook/LinkedIn
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="page">
    <header class="header header-logo avoid-break">
      <div class="brand">
        <img src="https://pct.com/vcard-new/assets/images/logo2-dark.png" alt="Pacific Coast Title" />
        <div class="title-block">
          <h1>Price Bands Analysis ‚Äî {{market_name}}</h1>
          <div class="sub">Period: {{period_label}} ‚Ä¢ Source: CRMLS/MLS ‚Ä¢ Report Date: {{report_date}}</div>
        </div>
      </div>
      <div class="badge">PCT Insights</div>
    </header>

    <section class="ribbon avoid-break">
      <div class="kpi">
        <div class="item"><div class="lbl">Total Listings</div><div class="val">{{total_listings}}</div></div>
        <div class="item"><div class="lbl">Median Price</div><div class="val">{{median_price}}</div></div>
        <div class="item"><div class="lbl">Avg DOM</div><div class="val">{{avg_dom}}</div></div>
        <div class="item"><div class="lbl">Price Range</div><div class="val">{{price_range}}</div></div>
      </div>
      <div class="chip">Market Segmentation</div>
    </section>

    <div class="insight-box avoid-break">
      <h4>üí° How to Use This Report</h4>
      <p><strong>Price Bands Analysis</strong> helps you identify where inventory is concentrated, which price points move fastest, and where investment opportunities exist. Use this to target buyers, set pricing strategies, and understand market segmentation. Hottest bands show high activity with low DOM.</p>
    </div>

    <div class="summary-grid avoid-break">
      <div class="summary-card">
        <div class="summary-label">HOTTEST PRICE BAND</div>
        <div class="summary-value">{{hottest_band}}</div>
        <div class="summary-note">{{hottest_count}} listings ‚Ä¢ {{hottest_dom}} avg DOM</div>
      </div>
      <div class="summary-card accent">
        <div class="summary-label">SLOWEST PRICE BAND</div>
        <div class="summary-value">{{slowest_band}}</div>
        <div class="summary-note">{{slowest_count}} listings ‚Ä¢ {{slowest_dom}} avg DOM</div>
      </div>
    </div>

    <div class="card">
      <h3>Price Band Distribution & Metrics</h3>
      <div id="bands-container"></div>
    </div>

    <footer class="footer avoid-break">
      <div class="foot-notes">
        Notes: Active listings unless stated. DOM = Days on Market. Price bands help identify market segments and buyer targets.
      </div>
      <div class="brandbar"><span class="dot"></span><span class="dot acc"></span><span class="tag">Pacific Coast Title ‚Ä¢ Market Intelligence</span></div>
    </footer>
  </div>

<script>
// Sample data structure - will be replaced by Python
window.DATA = [
  {
    band: "Under $500K",
    count: 45,
    percent: 15.2,
    medianPrice: 425000,
    avgDOM: 22,
    avgPPSF: 285,
    inventory: "High"
  },
  {
    band: "$500K - $750K",
    count: 89,
    percent: 30.1,
    medianPrice: 625000,
    avgDOM: 18,
    avgPPSF: 312,
    inventory: "Very High"
  },
  {
    band: "$750K - $1M",
    count: 72,
    percent: 24.3,
    medianPrice: 875000,
    avgDOM: 28,
    avgPPSF: 348,
    inventory: "High"
  },
  {
    band: "$1M - $1.5M",
    count: 54,
    percent: 18.2,
    medianPrice: 1250000,
    avgDOM: 35,
    avgPPSF: 382,
    inventory: "Moderate"
  },
  {
    band: "$1.5M - $2M",
    count: 21,
    percent: 7.1,
    medianPrice: 1725000,
    avgDOM: 48,
    avgPPSF: 415,
    inventory: "Low"
  },
  {
    band: "Over $2M",
    count: 15,
    percent: 5.1,
    medianPrice: 2850000,
    avgDOM: 62,
    avgPPSF: 468,
    inventory: "Low"
  }
];

// Render price bands
(function(){
  const container = document.getElementById('bands-container');
  const fmt = (n) => (typeof n === 'number' ? n.toLocaleString() : (n||"‚Äî"));
  const fmtPrice = (n) => (typeof n === 'number' ? '$' + n.toLocaleString() : "‚Äî");
  
  window.DATA.forEach(band => {
    const bandDiv = document.createElement('div');
    bandDiv.className = 'price-band';
    
    bandDiv.innerHTML = `
      <div class="band-header">
        <div class="band-title">${band.band}</div>
        <div class="band-count">${fmt(band.count)} listings</div>
      </div>
      <div class="band-visual">
        <div class="bar-container">
          <div class="bar-fill" style="width: ${band.percent}%;">
            ${band.percent >= 15 ? band.percent + '%' : ''}
          </div>
        </div>
        <div class="bar-percent">${band.percent}%</div>
      </div>
      <div class="band-metrics">
        <div class="metric-item">
          <div class="metric-label">Median Price</div>
          <div class="metric-value">${fmtPrice(band.medianPrice)}</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Avg DOM</div>
          <div class="metric-value">${fmt(band.avgDOM)} days</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Avg $/SqFt</div>
          <div class="metric-value">$${fmt(band.avgPPSF)}</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Inventory</div>
          <div class="metric-value" style="font-size: 13px;">${band.inventory}</div>
        </div>
      </div>
    `;
    
    container.appendChild(bandDiv);
  });
})();
</script>

<!-- html2canvas library for PNG export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Social Modal Functionality -->
<script>
  // Extract report data from the page
  function extractReportData() {
    console.log('window.DATA:', window.DATA);
    console.log('window.EMPLOYEE_DATA:', window.EMPLOYEE_DATA);
    
    const data = {
      city_name: document.querySelector('.title-block h1')?.textContent.replace('Price Bands Analysis ‚Äî ', '').trim() || 'Unknown',
      period_label: document.querySelector('.title-block .sub')?.textContent.split('‚Ä¢')[0].replace('Period:', '').trim() || '',
      // Extract rep info from footer if present
      rep_name: extractRepInfo('name'),
      rep_title: extractRepInfo('title'),
      rep_contact: extractRepInfo('contact'),
      rep_photo: extractRepInfo('photo'),
      // All price bands from window.DATA
      all_bands: window.DATA || []
    };
    
    console.log('Extracted report data:', data);
    return data;
  }

  function extractRepInfo(field) {
    // Prefer window.EMPLOYEE_DATA if available (more reliable)
    if (window.EMPLOYEE_DATA) {
      if (field === 'name') return window.EMPLOYEE_DATA.name || '';
      if (field === 'title') return window.EMPLOYEE_DATA.title || 'Title Rep ‚Ä¢ Pacific Coast Title';
      if (field === 'contact') {
        const email = window.EMPLOYEE_DATA.email || '';
        const phone = window.EMPLOYEE_DATA.mobile || '';
        return email + (phone ? ' ‚Ä¢ ' + phone : '');
      }
      if (field === 'photo') return window.EMPLOYEE_DATA.photo || '';
    }
    
    // Fallback to DOM extraction
    const footer = document.querySelector('.employee-footer');
    if (!footer) return '';
    
    if (field === 'name') {
      const nameEl = footer.querySelector('.employee-name, [style*="font-weight: 700"]');
      return nameEl?.textContent.trim() || '';
    } else if (field === 'title') {
      const titleEl = footer.querySelector('.employee-title');
      return titleEl?.textContent.trim() || 'Title Rep ‚Ä¢ Pacific Coast Title';
    } else if (field === 'contact') {
      const mobileEl = footer.querySelector('.employee-mobile');
      const emailEl = footer.querySelector('.employee-email');
      const mobile = mobileEl?.textContent.replace('üì±', '').trim() || '';
      const email = emailEl?.textContent.replace('‚úâÔ∏è', '').trim() || '';
      return email + (mobile ? ' ‚Ä¢ ' + mobile : '');
    } else if (field === 'photo') {
      const photoEl = footer.querySelector('.employee-photo, img[alt]');
      return photoEl?.src || '';
    }
    
    return '';
  }

  // Build social template URL with selected bands
  function buildSocialURL(theme = '') {
    const data = extractReportData();
    const selectedBands = getSelectedBands();
    
    if (selectedBands.length === 0) {
      return '';
    }
    
    const baseURL = '/vcard-new/socialtemplates-price-bands/index.html';
    
    // Format selected bands for social template
    const bandsData = selectedBands.map(band => ({
      range: band.band,
      sales: band.count,
      dom: band.avgDOM
    }));
    
    const params = new URLSearchParams({
      city_name: data.city_name,
      period_pill: data.period_label || 'Last 30 days',
      rep_name: data.rep_name,
      rep_title: data.rep_title,
      rep_contact: data.rep_contact,
      rep_photo: data.rep_photo,
      bands: JSON.stringify(bandsData),
      theme: theme
    });
    
    const url = `${baseURL}?${params.toString()}`;
    console.log('Social template URL:', url);
    return url;
  }

  // Populate checkbox list with price bands
  function populateCheckboxList() {
    const data = extractReportData();
    const container = document.getElementById('bandCheckboxList');
    container.innerHTML = '';
    
    data.all_bands.forEach((band, index) => {
      const item = document.createElement('div');
      item.className = 'checkbox-item';
      item.innerHTML = `
        <input type="checkbox" id="band_${index}" value="${index}" onchange="handleCheckboxChange()">
        <label for="band_${index}">${band.band} (${band.count} sales)</label>
      `;
      container.appendChild(item);
    });
    
    // Auto-select the first 4 bands with most activity
    const sortedByCount = [...data.all_bands]
      .map((band, idx) => ({ ...band, originalIndex: idx }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 4);
    
    sortedByCount.forEach(band => {
      const checkbox = document.getElementById(`band_${band.originalIndex}`);
      if (checkbox) {
        checkbox.checked = true;
      }
    });
    
    updateSelectionCounter();
    updateCheckboxState();
  }

  // Get selected bands
  function getSelectedBands() {
    const data = extractReportData();
    const checkboxes = document.querySelectorAll('#bandCheckboxList input[type="checkbox"]:checked');
    const selectedBands = [];
    
    checkboxes.forEach(checkbox => {
      const index = parseInt(checkbox.value);
      if (data.all_bands[index]) {
        selectedBands.push(data.all_bands[index]);
      }
    });
    
    return selectedBands;
  }

  // Handle checkbox change
  function handleCheckboxChange() {
    updateSelectionCounter();
    updateCheckboxState();
    updatePreview();
  }

  // Update selection counter
  function updateSelectionCounter() {
    const selectedCount = document.querySelectorAll('#bandCheckboxList input[type="checkbox"]:checked').length;
    const counter = document.getElementById('selectionCounter');
    counter.textContent = `Selected: ${selectedCount}/4`;
    
    if (selectedCount >= 4) {
      counter.classList.add('max');
    } else {
      counter.classList.remove('max');
    }
  }

  // Update checkbox state (disable unchecked when 4 are selected)
  function updateCheckboxState() {
    const selectedCount = document.querySelectorAll('#bandCheckboxList input[type="checkbox"]:checked').length;
    const checkboxes = document.querySelectorAll('#bandCheckboxList input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
      if (selectedCount >= 4 && !checkbox.checked) {
        checkbox.disabled = true;
        checkbox.parentElement.classList.add('disabled');
      } else {
        checkbox.disabled = false;
        checkbox.parentElement.classList.remove('disabled');
      }
    });
  }

  function openSocialModal() {
    const modal = document.getElementById('socialModal');
    modal.classList.add('active');
    populateCheckboxList();
    updatePreview();
  }

  function closeSocialModal() {
    const modal = document.getElementById('socialModal');
    modal.classList.remove('active');
  }

  function updatePreview() {
    const theme = document.getElementById('themeSelect').value;
    const iframe = document.getElementById('socialPreview');
    const url = buildSocialURL(theme);
    
    if (url) {
      iframe.src = url;
    } else {
      iframe.src = '';
    }
  }

  async function downloadSocialGraphic() {
    const selectedBands = getSelectedBands();
    
    if (selectedBands.length === 0) {
      alert('Please select at least 1 price band (max 4)');
      return;
    }
    
    const btn = document.getElementById('downloadBtn');
    const btnText = document.getElementById('downloadText');
    const originalText = btnText.textContent;
    
    try {
      btn.disabled = true;
      btnText.textContent = '‚è≥ Generating...';
      
      const iframe = document.getElementById('socialPreview');
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      const body = iframeDoc.body;
      
      // Wait for iframe to fully load
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      console.log('Capturing element:', body);
      console.log('Element dimensions:', body.offsetWidth, 'x', body.offsetHeight);
      
      // Set explicit dimensions for capture
      const originalWidth = body.style.width;
      const originalHeight = body.style.height;
      body.style.width = '1080px';
      body.style.height = '1920px';
      
      // Wait for repaint
      await new Promise(resolve => setTimeout(resolve, 100));
      
      const canvas = await html2canvas(body, {
        width: 1080,
        height: 1920,
        scale: 4, // 4√ó scale = 4320√ó7680 @ 300 DPI
        useCORS: true,
        allowTaint: true,
        backgroundColor: null,
        logging: false,
        removeContainer: false
      });
      
      console.log('Canvas generated:', canvas.width, 'x', canvas.height);
      
      // Restore original dimensions
      body.style.width = originalWidth;
      body.style.height = originalHeight;
      
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const data = extractReportData();
        const citySlug = data.city_name.toLowerCase().replace(/\s+/g, '-');
        a.href = url;
        a.download = `price-bands-${citySlug}-300dpi.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('Download initiated:', a.download);
        
        btnText.textContent = '‚úÖ Downloaded!';
        setTimeout(() => {
          btnText.textContent = originalText;
          btn.disabled = false;
        }, 2000);
      }, 'image/png');
      
    } catch (error) {
      console.error('Error generating social graphic:', error);
      btnText.textContent = '‚ùå Error - Try Again';
      setTimeout(() => {
        btnText.textContent = originalText;
        btn.disabled = false;
      }, 2000);
    }
  }

  // Close modal when clicking outside
  document.getElementById('socialModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeSocialModal();
    }
  });
</script>
</body>
</html>

