<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>PCT ‚Ä¢ Closed Listings by City</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>

  /* ====== Print Setup ====== */
  @page {
    size: letter;
    margin: 0.2in;
  }
  @media print {
    @page {
      margin: 0.2in;
      size: Letter;
    }
    html, body { 
      background: #fff !important; 
      margin: 0 !important;
      padding: 0 !important;
    }
    .page { 
      box-shadow: none !important; 
      width: 100% !important;
      min-height: auto !important;
      margin: 0 !important;
      padding: 0.15in !important;
    }
    
    /* Repeat table header on each page */
    table thead {
      display: table-header-group;
    }
    
    /* Prevent rows from breaking across pages */
    table tr {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    /* Header logo section - repeat on each page */
    .header-logo {
      page-break-before: avoid;
      page-break-after: avoid;
    }
    
    /* Ribbon section - keep on first page */
    .ribbon {
      page-break-after: avoid;
      page-break-inside: avoid;
    }
    
    /* Table section - allow natural breaks */
    .data-section {
      page-break-before: auto;
      page-break-inside: auto;
    }
    
    /* Footer - appears at bottom of each page */
    .employee-footer {
      page-break-inside: avoid;
      page-break-before: auto;
      margin-top: 20px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px 0.2in;
      background: #fff;
      border-top: 2px solid #e5e7eb;
    }
    
    a { color: inherit; text-decoration: none; }
    .no-print { display: none !important; }
    .avoid-break { break-inside: avoid; page-break-inside: avoid; }
    * { 
      -webkit-print-color-adjust: exact; 
      print-color-adjust: exact; 
    }
  }

  html, body {
    height: 100%;
    margin: 0;
    background: #f3f4f6;
    font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: #111827;
  }

  :root{
    --pct-blue: rgb(37,99,235);
    --pct-gray: rgb(247,249,252);
    --pct-accent: #f26b2b;
    --ink: #0f172a;
    --muted: #6b7280;
    --border: #e5e7eb;
    --success: #16a34a;
    --danger: #dc2626;
  }

  .page{
    width: 8.5in;
    min-height: 11in;
    box-sizing: border-box;
    margin: 0 auto;
    background: white;
    box-shadow: 0 2px 24px rgba(0,0,0,.06);
    padding: 0.5in;
  }

  .header{
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
    margin-bottom: 14px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .brand img{ height: 44px; width: auto; display:block; }
  .title-block h1{
    font-size: 22px; line-height:1.2; margin:0; color: var(--ink);
    letter-spacing: .2px;
  }
  .title-block .sub{ margin-top: 2px; font-size: 12px; color: var(--muted); }
  .badge{
    background: var(--pct-blue); color: #fff; 
    padding: 8px 12px; border-radius: 999px; font-weight: 600; font-size: 12px;
  }

  .ribbon{
    background: linear-gradient(90deg, var(--pct-blue), var(--pct-accent));
    color: #fff; border-radius: 14px;
    padding: 14px 18px; margin: 6px 0 16px;
    display:grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
  }
  .ribbon .kpi{ display:flex; gap: 24px; flex-wrap: nowrap; }
  .ribbon .kpi .item{ min-width: 120px; }
  .ribbon .kpi .lbl{ font-size: 11px; opacity:.9; letter-spacing:.3px; }
  .ribbon .kpi .val{ font-size: 20px; font-weight: 700; line-height:1.1; }

  .card{
    background: #fff; border: 1px solid var(--border);
    border-radius: 14px; padding: 12px 14px;
  }
  .card h3{
    margin: 0 0 8px; font-size: 13px; letter-spacing:.2px; color: var(--muted);
    text-transform: uppercase;
  }

  .stack > * { margin-bottom: 14px; }

  .stat-grid{ display:grid; grid-template-columns: repeat(4,1fr); gap: 10px; }
  .mini{ background: var(--pct-gray); border: 1px dashed #e6ebf1; border-radius: 12px; padding: 10px 12px; }
  .mini .label{ font-size: 11px; color: #4b5563; }
  .mini .value{ font-size: 16px; font-weight: 700; color: var(--ink); }
  .delta{ font-size: 11px; margin-top: 2px; display:flex; align-items:center; gap:6px; font-weight: 600; }
  .delta.up{ color: var(--success); }
  .delta.down{ color: var(--danger); }

  .meter{ height: 8px; background: #eef2ff; border-radius: 999px; overflow:hidden; margin-top: 8px; }
  .meter > span{ display:block; height: 100%; width: var(--w, 50%); background: var(--pct-blue); }

  table{ width:100%; border-collapse: collapse; font-size: 12px; }
  th, td{ padding: 8px 8px; border-bottom: 1px solid var(--border); }
  th{ text-align:left; color: #374151; font-weight: 700; font-size: 11.5px; }
  tbody tr:last-child td{ border-bottom: none; }
  .t-right{ text-align:right; }
  .chip{ font-size: 10px; padding: 2px 6px; border-radius: 999px; background: #eef2ff; color: #1f3aa8; font-weight: 700; }

  .spark{ width: 100%; height: 36px; display:block; }
  .spark path{ stroke: var(--pct-blue); fill: rgba(37,99,235,0.12); stroke-width: 2; }

  .footer{ margin-top: 12px; display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
  .foot-notes{ font-size: 10.5px; color: #6b7280; }
  .brandbar{ display:flex; gap: 10px; align-items:center; }
  .brandbar .dot{ width:10px; height:10px; border-radius:999px; background: var(--pct-blue); }
  .brandbar .dot.acc{ background: var(--pct-accent); }
  .brandbar .tag{ font-weight: 800; letter-spacing: .4px; color: #111827; font-size: 11px; }

  /* Action buttons */
  .action-buttons {
    position: fixed; top: 20px; right: 20px; 
    display: flex; gap: 10px; z-index: 1000;
  }
  .print-btn, .social-btn{
    background: var(--pct-blue); color: #fff; border: none;
    padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 14px;
    cursor: pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    transition: all 0.2s;
  }
  .print-btn:hover, .social-btn:hover{
    background: var(--pct-accent); transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(242,107,43,0.4);
  }
  .social-btn {
    background: #10b981;
    box-shadow: 0 4px 12px rgba(16,185,129,0.3);
  }
  .social-btn:hover {
    background: #059669;
    box-shadow: 0 6px 16px rgba(5,150,105,0.4);
  }
  @media print {
    .action-buttons { display: none; }
  }
  
  /* Social Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: white;
    border-radius: 16px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow: auto;
    padding: 30px;
    position: relative;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .modal-header h2 {
    margin: 0;
    color: #111827;
  }
  .modal-close {
    background: #ef4444;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    line-height: 1;
  }
  .modal-body {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
    align-items: start;
  }
  .preview-container {
    background: #f3f4f6;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .preview-frame {
    width: 270px;
    height: 480px;
    border: 3px solid #111827;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  }
  .preview-frame iframe {
    width: 1080px;
    height: 1920px;
    border: none;
    transform: scale(0.25);
    transform-origin: 0 0;
  }
  .controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .control-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #374151;
    font-size: 14px;
  }
  .control-group select {
    width: 100%;
    padding: 10px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
  }
  .download-btn {
    background: var(--pct-blue);
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s;
  }
  .download-btn:hover {
    background: var(--pct-accent);
    transform: translateY(-2px);
  }
  .download-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }

</style>
</head>
<body>
  <!-- Action Buttons -->
  <div class="action-buttons no-print">
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
    <button class="social-btn" onclick="openSocialModal()">üì± Generate Social Graphic</button>
  </div>

  <!-- Social Modal -->
  <div id="socialModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì± Generate Social Graphic</h2>
        <button class="modal-close" onclick="closeSocialModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="preview-container">
          <div class="preview-frame">
            <iframe id="socialPreview" src=""></iframe>
          </div>
        </div>
        <div class="controls">
          <div class="control-group">
            <label for="themeSelect">Background Theme</label>
            <select id="themeSelect" onchange="updatePreview()">
              <option value="">Sunset Wave (Default)</option>
              <option value="classic">Classic Gradient</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </div>
          <div class="control-group">
            <label>Preview Size</label>
            <p style="margin: 0; font-size: 13px; color: #6b7280;">1080 √ó 1920 (Instagram/Facebook Story)</p>
          </div>
          <button class="download-btn" onclick="downloadSocialGraphic()" id="downloadBtn">
            <span id="downloadText">üì• Download PNG (300 DPI - 4320√ó7680)</span>
          </button>
          <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">
            Print-quality 300 DPI output ‚Ä¢ Perfect for Instagram/Facebook/LinkedIn
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="page">
    <header class="header header-logo avoid-break">
      <div class="brand">
        <img src="https://pct.com/vcard-new/assets/images/logo2-dark.png" alt="Pacific Coast Title" />
        <div class="title-block">
          <h1>Closed Listings by City ‚Äî {{market_name}}</h1>
          <div class="sub">Period: {{period_label}} ‚Ä¢ Source: CRMLS/MLS ‚Ä¢ Report Date: {{report_date}}</div>
        </div>
      </div>
      <div class="badge">PCT Insights</div>
    </header>

    <section class="ribbon avoid-break">
      <div class="kpi">
        <div class="item"><div class="lbl">Total Closings</div><div class="val">{{total_closed}}</div></div>
        <div class="item"><div class="lbl">Median Sale Price</div><div class="val">{{median_price}}</div></div>
        <div class="item"><div class="lbl">Avg DOM</div><div class="val">{{avg_dom}}</div></div>
        <div class="item"><div class="lbl">Close/Ask Ratio</div><div class="val">{{ctl}}%</div></div>
      </div>
      <div class="chip">Compared to {{compare_period}}</div>
    </section>

    <section class="stack data-section">
      <div class="card">
        <h3>Recent Closings ‚Äî Sorted by Close Date</h3>
        <table>
          <thead>
            <tr>
              <th>City</th>
              <th>Address</th>
              <th class="t-right">Close Price</th>
              <th class="t-right">Beds</th>
              <th class="t-right">Baths</th>
              <th class="t-right">SqFt</th>
              <th class="t-right">DOM</th>
              <th class="t-right">Close Date</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <footer class="footer avoid-break">
      <div class="foot-notes">
        Notes: Residential resale unless stated. Figures reflect {{period_label}} and may be revised by MLS.
      </div>
      <div class="brandbar"><span class="dot"></span><span class="dot acc"></span><span class="tag">Pacific Coast Title ‚Ä¢ Market Intelligence</span></div>
    </footer>
  </div>

<script>
window.DATA = [
  {city: "Irvine", address: "123 Main St", closePrice: 950000, beds: 3, baths: 2, sqft: 1800, dom: 25, closeDate: "2024-10-15"},
  {city: "Anaheim", address: "456 Oak Ave", closePrice: 725000, beds: 4, baths: 2.5, sqft: 2100, dom: 18, closeDate: "2024-10-12"}
];

(function(){
  const rows = document.getElementById('rows');
  const sorted = window.DATA.slice().sort((a,b)=> {
    // Sort by close date descending (most recent first)
    return (b.closeDate||"").localeCompare(a.closeDate||"");
  });
  const fmt = (n) => (typeof n === 'number' ? n.toLocaleString() : (n||"‚Äî"));
  const fmtPrice = (n) => (typeof n === 'number' ? '$' + n.toLocaleString() : "‚Äî");
  const fmtDate = (dateStr) => {
    if (!dateStr || dateStr === "‚Äî") return "‚Äî";
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch(e) {
      return dateStr;
    }
  };
  
  sorted.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.city||"‚Äî"}</td>
      <td>${d.address||"‚Äî"}</td>
      <td class="t-right">${fmtPrice(d.closePrice)}</td>
      <td class="t-right">${fmt(d.beds)}</td>
      <td class="t-right">${fmt(d.baths)}</td>
      <td class="t-right">${fmt(d.sqft)}</td>
      <td class="t-right">${fmt(d.dom)}</td>
      <td class="t-right">${fmtDate(d.closeDate)}</td>
    `;
    rows.appendChild(tr);
  });
})();
</script>

<!-- html2canvas library for PNG export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Social Modal Functionality -->
<script>
  // Extract report data from the page
  function extractReportData() {
    console.log('window.DATA:', window.DATA);
    console.log('window.EMPLOYEE_DATA:', window.EMPLOYEE_DATA);
    
    const data = {
      city_name: document.querySelector('.title-block h1')?.textContent.replace('Closed Listings by City ‚Äî ', '').trim() || 'Unknown',
      period_label: document.querySelector('.title-block .sub')?.textContent.split('‚Ä¢')[0].replace('Period:', '').trim() || '',
      // Extract metrics from ribbon
      total_closed: document.querySelector('.ribbon .kpi .item:nth-child(1) .val')?.textContent.trim() || '0',
      median_price: document.querySelector('.ribbon .kpi .item:nth-child(2) .val')?.textContent.trim() || '$0',
      avg_dom: document.querySelector('.ribbon .kpi .item:nth-child(3) .val')?.textContent.trim() || '0',
      close_ratio: document.querySelector('.ribbon .kpi .item:nth-child(4) .val')?.textContent.trim() || '0%',
      // Extract rep info from footer if present
      rep_name: extractRepInfo('name'),
      rep_title: extractRepInfo('title'),
      rep_contact: extractRepInfo('contact'),
      rep_photo: extractRepInfo('photo'),
      // Extract listings data - 5 most recent (already sorted by close date)
      listings: window.DATA ? window.DATA.slice(0, 5).map(listing => ({
        address: listing.address || '',
        price: listing.closePrice || 0
      })) : []
    };
    
    console.log('Extracted report data:', data);
    return data;
  }

  function extractRepInfo(field) {
    // Prefer window.EMPLOYEE_DATA if available (more reliable)
    if (window.EMPLOYEE_DATA) {
      if (field === 'name') return window.EMPLOYEE_DATA.name || '';
      if (field === 'title') return window.EMPLOYEE_DATA.title || 'Title Rep ‚Ä¢ Pacific Coast Title';
      if (field === 'contact') {
        const email = window.EMPLOYEE_DATA.email || '';
        const phone = window.EMPLOYEE_DATA.mobile || '';
        return email + (phone ? ' ‚Ä¢ ' + phone : '');
      }
      if (field === 'photo') return window.EMPLOYEE_DATA.photo || '';
    }
    
    // Fallback to DOM extraction
    const footer = document.querySelector('.employee-footer');
    if (!footer) return '';
    
    if (field === 'name') {
      const nameEl = footer.querySelector('.employee-name, [style*="font-weight: 700"]');
      return nameEl?.textContent.trim() || '';
    } else if (field === 'title') {
      const titleEl = footer.querySelector('.employee-title');
      return titleEl?.textContent.trim() || 'Title Rep ‚Ä¢ Pacific Coast Title';
    } else if (field === 'contact') {
      const mobileEl = footer.querySelector('.employee-mobile');
      const emailEl = footer.querySelector('.employee-email');
      const mobile = mobileEl?.textContent.replace('üì±', '').trim() || '';
      const email = emailEl?.textContent.replace('‚úâÔ∏è', '').trim() || '';
      return email + (mobile ? ' ‚Ä¢ ' + mobile : '');
    } else if (field === 'photo') {
      const photoEl = footer.querySelector('.employee-photo, img[alt]');
      return photoEl?.src || '';
    }
    
    return '';
  }

  // Build social template URL
  function buildSocialURL(theme = '') {
    const data = extractReportData();
    const baseURL = '/vcard-new/socialtemplates-closed/index.html';
    
    const params = new URLSearchParams({
      city_name: data.city_name,
      period_pill: data.period_label || 'Last 30 days',
      total_closed: data.total_closed,
      median_price: data.median_price.replace('$', '').replace(/,/g, ''), // Remove $ and commas for parsing
      avg_dom: data.avg_dom,
      close_ratio: data.close_ratio,
      rep_name: data.rep_name,
      rep_title: data.rep_title,
      rep_contact: data.rep_contact,
      rep_photo: data.rep_photo,
      listings: JSON.stringify(data.listings),
      theme: theme
    });
    
    const url = `${baseURL}?${params.toString()}`;
    console.log('Social template URL:', url);
    return url;
  }

  function openSocialModal() {
    const modal = document.getElementById('socialModal');
    modal.classList.add('active');
    updatePreview();
  }

  function closeSocialModal() {
    const modal = document.getElementById('socialModal');
    modal.classList.remove('active');
  }

  function updatePreview() {
    const theme = document.getElementById('themeSelect').value;
    const iframe = document.getElementById('socialPreview');
    iframe.src = buildSocialURL(theme);
  }

  async function downloadSocialGraphic() {
    const btn = document.getElementById('downloadBtn');
    const btnText = document.getElementById('downloadText');
    const originalText = btnText.textContent;
    
    try {
      btn.disabled = true;
      btnText.textContent = '‚è≥ Generating...';
      
      const iframe = document.getElementById('socialPreview');
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      const body = iframeDoc.body;
      
      // Wait for iframe to fully load
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      console.log('Capturing element:', body);
      console.log('Element dimensions:', body.offsetWidth, 'x', body.offsetHeight);
      
      // Set explicit dimensions for capture
      const originalWidth = body.style.width;
      const originalHeight = body.style.height;
      body.style.width = '1080px';
      body.style.height = '1920px';
      
      // Wait for repaint
      await new Promise(resolve => setTimeout(resolve, 100));
      
      const canvas = await html2canvas(body, {
        width: 1080,
        height: 1920,
        scale: 4, // 4√ó scale = 4320√ó7680 @ 300 DPI
        useCORS: true,
        allowTaint: true,
        backgroundColor: null,
        logging: false,
        removeContainer: false
      });
      
      console.log('Canvas generated:', canvas.width, 'x', canvas.height);
      
      // Restore original dimensions
      body.style.width = originalWidth;
      body.style.height = originalHeight;
      
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const data = extractReportData();
        const citySlug = data.city_name.toLowerCase().replace(/\s+/g, '-');
        a.href = url;
        a.download = `closed-listings-${citySlug}-300dpi.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('Download initiated:', a.download);
        
        btnText.textContent = '‚úÖ Downloaded!';
        setTimeout(() => {
          btnText.textContent = originalText;
          btn.disabled = false;
        }, 2000);
      }, 'image/png');
      
    } catch (error) {
      console.error('Error generating social graphic:', error);
      btnText.textContent = '‚ùå Error - Try Again';
      setTimeout(() => {
        btnText.textContent = originalText;
        btn.disabled = false;
      }, 2000);
    }
  }

  // Close modal when clicking outside
  document.getElementById('socialModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeSocialModal();
    }
  });
</script>
</body>
</html>
