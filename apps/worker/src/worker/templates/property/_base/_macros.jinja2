{# =============================================================================
   PROPERTY REPORT MACROS
   Reusable components for all property report themes
   ============================================================================= #}

{# -----------------------------------------------------------------------------
   PAGE HEADER
   Consistent header for internal pages (not cover)
   Usage: {{ macros.page_header(title, subtitle) }}
   ----------------------------------------------------------------------------- #}
{% macro page_header(title, subtitle=None) %}
<header class="page-header">
  <div class="page-header-content">
    <h1 class="page-title">{{ title }}</h1>
    {% if subtitle %}
    <p class="page-subtitle">{{ subtitle }}</p>
    {% endif %}
  </div>
  <div class="page-header-accent"></div>
</header>
{% endmacro %}

{# -----------------------------------------------------------------------------
   PAGE FOOTER
   Consistent footer for all pages
   Usage: {{ macros.page_footer(agent, page_num) }}
   ----------------------------------------------------------------------------- #}
{% macro page_footer(agent, page_num=None) %}
<footer class="page-footer">
  <div class="footer-left">
    {% if agent.photo_url %}
    <img src="{{ agent.photo_url }}" alt="{{ agent.name }}" class="footer-agent-photo">
    {% else %}
    <div class="footer-agent-photo footer-agent-photo--placeholder">
      {{ agent.name[0] | upper }}
    </div>
    {% endif %}
    <div class="footer-agent-info">
      <span class="footer-agent-name">{{ agent.name }}</span>
      <span class="footer-agent-contact">{{ agent.phone }}</span>
    </div>
  </div>
  <div class="footer-right">
    {% if agent.logo_url %}
    <img src="{{ agent.logo_url }}" alt="{{ agent.company_name }}" class="footer-logo">
    {% else %}
    <span class="footer-company">{{ agent.company_name }}</span>
    {% endif %}
  </div>
</footer>
{% endmacro %}

{# -----------------------------------------------------------------------------
   COVER FOOTER (Agent Block)
   Larger agent display for cover page
   Usage: {{ macros.cover_agent_block(agent) }}
   ----------------------------------------------------------------------------- #}
{% macro cover_agent_block(agent) %}
<div class="cover-footer">
  <div class="cover-agent">
    {% if agent.photo_url %}
    <img src="{{ agent.photo_url }}" alt="{{ agent.name }}" class="cover-agent-photo">
    {% else %}
    <div class="cover-agent-photo cover-agent-photo--placeholder">
      {{ agent.name[0] | upper }}
    </div>
    {% endif %}
    <div class="cover-agent-info">
      <h3 class="cover-agent-name">{{ agent.name }}</h3>
      <p class="cover-agent-title">{{ agent.title | default('Realtor®') }}{% if agent.license %} · {{ agent.license }}{% endif %}</p>
      <p class="cover-agent-contact">{{ agent.phone }}{% if agent.email %} · {{ agent.email }}{% endif %}</p>
    </div>
  </div>
  <div class="cover-branding">
    {% if agent.logo_url %}
    <img src="{{ agent.logo_url }}" alt="{{ agent.company_name }}" class="cover-logo">
    {% else %}
    <div class="cover-company-text">
      <span class="cover-company-name">{{ agent.company_name }}</span>
      {% if agent.company_tagline %}
      <span class="cover-company-tagline">{{ agent.company_tagline }}</span>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   PROPERTY STATS ROW
   Horizontal stats display (beds, baths, sqft, year)
   Usage: {{ macros.property_stats(property) }}
   ----------------------------------------------------------------------------- #}
{% macro property_stats(property) %}
<div class="property-stats">
  {% if property.bedrooms %}
  <div class="stat-item">
    <span class="stat-value">{{ property.bedrooms }}</span>
    <span class="stat-label">Beds</span>
  </div>
  {% endif %}
  {% if property.bathrooms %}
  <div class="stat-item">
    <span class="stat-value">{{ property.bathrooms }}</span>
    <span class="stat-label">Baths</span>
  </div>
  {% endif %}
  {% if property.sqft %}
  <div class="stat-item">
    <span class="stat-value">{{ property.sqft | format_number }}</span>
    <span class="stat-label">Sq Ft</span>
  </div>
  {% endif %}
  {% if property.year_built %}
  <div class="stat-item">
    <span class="stat-value">{{ property.year_built }}</span>
    <span class="stat-label">Built</span>
  </div>
  {% endif %}
  {% if property.lot_size %}
  <div class="stat-item">
    <span class="stat-value">{{ property.lot_size | format_number }}</span>
    <span class="stat-label">Lot Sq Ft</span>
  </div>
  {% endif %}
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   DATA TABLE
   Generic two-column data table
   Usage: {{ macros.data_table(rows) }}
   rows = [{'label': 'APN', 'value': '1234-567'}, ...]
   ----------------------------------------------------------------------------- #}
{% macro data_table(rows, title=None) %}
{% if title %}
<h3 class="table-title">{{ title }}</h3>
{% endif %}
<table class="data-table">
  <tbody>
    {% for row in rows %}
    {% if row.value %}
    <tr>
      <td class="data-label">{{ row.label }}</td>
      <td class="data-value">{{ row.value }}</td>
    </tr>
    {% endif %}
    {% endfor %}
  </tbody>
</table>
{% endmacro %}

{# -----------------------------------------------------------------------------
   PROPERTY DETAILS TABLE
   Pre-built property details using data_table
   Usage: {{ macros.property_details_table(property) }}
   ----------------------------------------------------------------------------- #}
{% macro property_details_table(property) %}
{{ data_table([
  {'label': 'Property Type', 'value': property.property_type},
  {'label': 'Bedrooms', 'value': property.bedrooms},
  {'label': 'Bathrooms', 'value': property.bathrooms},
  {'label': 'Square Feet', 'value': property.sqft | format_number if property.sqft else None},
  {'label': 'Lot Size', 'value': (property.lot_size | format_number ~ ' sq ft') if property.lot_size else None},
  {'label': 'Year Built', 'value': property.year_built},
  {'label': 'Garage', 'value': (property.garage ~ ' Car') if property.garage else None},
  {'label': 'Pool', 'value': property.pool},
  {'label': 'Zoning', 'value': property.zoning}
], 'Property Details') }}
{% endmacro %}

{# -----------------------------------------------------------------------------
   TAX & ASSESSMENT TABLE
   Pre-built tax details
   Usage: {{ macros.tax_table(property) }}
   ----------------------------------------------------------------------------- #}
{% macro tax_table(property) %}
{{ data_table([
  {'label': 'APN', 'value': property.apn},
  {'label': 'Assessed Value', 'value': property.assessed_value | format_currency if property.assessed_value else None},
  {'label': 'Land Value', 'value': property.land_value | format_currency if property.land_value else None},
  {'label': 'Improvement Value', 'value': property.improvement_value | format_currency if property.improvement_value else None},
  {'label': 'Annual Taxes', 'value': property.tax_amount | format_currency if property.tax_amount else None},
  {'label': 'Tax Year', 'value': property.tax_year}
], 'Tax Information') }}
{% endmacro %}

{# -----------------------------------------------------------------------------
   LOCATION TABLE
   Pre-built location details
   Usage: {{ macros.location_table(property) }}
   ----------------------------------------------------------------------------- #}
{% macro location_table(property) %}
{{ data_table([
  {'label': 'Address', 'value': property.street_address},
  {'label': 'City', 'value': property.city},
  {'label': 'State', 'value': property.state},
  {'label': 'ZIP Code', 'value': property.zip_code},
  {'label': 'County', 'value': property.county},
  {'label': 'Census Tract', 'value': property.census_tract}
], 'Location') }}
{% endmacro %}

{# -----------------------------------------------------------------------------
   KEY STATS BAR
   Prominent colored bar for property details page (Beds/Baths/SqFt/Year)
   Usage: {{ macros.property_key_stats_bar(property) }}
   ----------------------------------------------------------------------------- #}
{% macro property_key_stats_bar(property) %}
<div class="key-stats-bar">
  <div class="key-stat-item">
    <span class="key-stat-value">{{ property.bedrooms }}</span>
    <span class="key-stat-label">Beds</span>
  </div>
  <div class="key-stat-divider"></div>
  <div class="key-stat-item">
    <span class="key-stat-value">{{ property.bathrooms }}</span>
    <span class="key-stat-label">Baths</span>
  </div>
  <div class="key-stat-divider"></div>
  <div class="key-stat-item">
    <span class="key-stat-value">{{ property.sqft | format_number }}</span>
    <span class="key-stat-label">Sq Ft</span>
  </div>
  <div class="key-stat-divider"></div>
  <div class="key-stat-item">
    <span class="key-stat-value">{{ property.year_built }}</span>
    <span class="key-stat-label">Year Built</span>
  </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   COMP CARD
   Individual comparable property card
   Usage: {{ macros.comp_card(comp, index) }}
   ----------------------------------------------------------------------------- #}
{% macro comp_card(comp, index=1) %}
<div class="comp-card">
  {# Photo FIRST, then header — matches V0 design: image on top, header bar below #}
  {% if comp.photo_url or comp.map_image_url %}
  <div class="comp-image">
    <img src="{{ comp.photo_url | default(comp.map_image_url) }}" alt="{{ comp.address }}">
  </div>
  {% endif %}
  <div class="comp-card-header">
    <span class="comp-number">{{ index }}</span>
    <span class="comp-price">{{ comp.sale_price | format_currency }}</span>
  </div>
  <div class="comp-details">
    <h4 class="comp-address">{{ comp.address }}</h4>
    <div class="comp-meta">
      <span>{{ comp.bedrooms }} bd</span>
      <span class="comp-meta-divider">·</span>
      <span>{{ comp.bathrooms }} ba</span>
      <span class="comp-meta-divider">·</span>
      <span>{{ comp.sqft | format_number }} sqft</span>
    </div>
    <div class="comp-stats">
      <div class="comp-stat">
        <span class="comp-stat-value">{{ comp.price_per_sqft | format_currency }}</span>
        <span class="comp-stat-label">$/sqft</span>
      </div>
      <div class="comp-stat">
        <span class="comp-stat-value">{{ comp.sold_date }}</span>
        <span class="comp-stat-label">Sold</span>
      </div>
      <div class="comp-stat">
        <span class="comp-stat-value">{{ comp.distance_miles }} mi</span>
        <span class="comp-stat-label">Distance</span>
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   COMP GRID
   Grid of comparable cards
   Usage: {{ macros.comp_grid(comparables) }}
   ----------------------------------------------------------------------------- #}
{% macro comp_grid(comparables) %}
<div class="comp-grid">
  {% for comp in comparables[:4] %}
  {{ comp_card(comp, loop.index) }}
  {% endfor %}
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   ANALYSIS SUMMARY
   Price range summary with subject property comparison
   Usage: {{ macros.analysis_summary(stats, property) }}
   ----------------------------------------------------------------------------- #}
{% macro analysis_summary(stats, property) %}
<div class="analysis-summary">
  <div class="analysis-range">
    <div class="range-item range-low">
      <span class="range-label">Low</span>
      <span class="range-value">{{ stats.price_low | format_currency }}</span>
    </div>
    <div class="range-item range-median">
      <span class="range-label">Median</span>
      <span class="range-value">{{ stats.medium.price | format_currency }}</span>
    </div>
    <div class="range-item range-high">
      <span class="range-label">High</span>
      <span class="range-value">{{ stats.price_high | format_currency }}</span>
    </div>
  </div>
  <div class="analysis-stats">
    <div class="analysis-stat">
      <span class="analysis-stat-value">{{ stats.total_comps }}</span>
      <span class="analysis-stat-label">Comparables</span>
    </div>
    <div class="analysis-stat">
      <span class="analysis-stat-value">{{ stats.avg_sqft | format_number }}</span>
      <span class="analysis-stat-label">Avg Sq Ft</span>
    </div>
    <div class="analysis-stat">
      <span class="analysis-stat-value">{{ stats.avg_beds }}</span>
      <span class="analysis-stat-label">Avg Beds</span>
    </div>
    <div class="analysis-stat">
      <span class="analysis-stat-value">{{ stats.avg_baths }}</span>
      <span class="analysis-stat-label">Avg Baths</span>
    </div>
  </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   COMPARISON TABLE
   Subject vs Comp Average table with green/red indicators
   Usage: {{ macros.comparison_table(stats, property) }}
   ----------------------------------------------------------------------------- #}
{% macro comparison_table(stats, property) %}
<div class="comparison-section">
  <h3 class="section-title">Subject Property vs. Comparable Averages</h3>
  <div class="comparison-table">
    <div class="comparison-header">
      <span>Metric</span>
      <span>Subject Property</span>
      <span>Comp Average</span>
      <span>Difference</span>
    </div>
    {% set piq_price = stats.piq.price | default(0, true) | float %}
    {% set med_price = stats.medium.price | default(0, true) | float %}
    {% set subj_sqft = property.sqft | default(0, true) | float %}
    {% set avg_sqft_val = stats.avg_sqft | default(0, true) | float %}
    {% set subj_beds = property.bedrooms | default(0, true) | float %}
    {% set avg_beds_val = stats.avg_beds | default(0, true) | float %}
    {% set subj_baths = property.bathrooms | default(0, true) | float %}
    {% set avg_baths_val = stats.avg_baths | default(0, true) | float %}
    {% set piq_ppsf = stats.piq.price_per_sqft | default(0, true) | float %}
    {% set avg_ppsf = stats.avg_price_per_sqft | default(0, true) | float %}
    {% set rows = [
      {'metric': 'Price', 'subject': piq_price | format_currency, 'comp': med_price | format_currency, 'diff': piq_price - med_price, 'is_currency': true},
      {'metric': 'Sq Ft', 'subject': subj_sqft | int | format_number, 'comp': avg_sqft_val | int | format_number, 'diff': subj_sqft - avg_sqft_val, 'is_currency': false},
      {'metric': 'Beds', 'subject': subj_beds | int, 'comp': avg_beds_val | round(1), 'diff': subj_beds - avg_beds_val, 'is_currency': false},
      {'metric': 'Baths', 'subject': subj_baths | round(1), 'comp': avg_baths_val | round(1), 'diff': subj_baths - avg_baths_val, 'is_currency': false},
      {'metric': '$/Sq Ft', 'subject': piq_ppsf | format_currency, 'comp': avg_ppsf | format_currency, 'diff': piq_ppsf - avg_ppsf, 'is_currency': true}
    ] %}
    {% for row in rows %}
    <div class="comparison-row {% if loop.index is odd %}comparison-row-stripe{% endif %}">
      <span class="comparison-metric">{{ row.metric }}</span>
      <span class="comparison-subject">{{ row.subject }}</span>
      <span class="comparison-comp">{{ row.comp }}</span>
      <span class="comparison-diff {% if row.diff | default(0) >= 0 %}diff-positive{% else %}diff-negative{% endif %}">
        {% if row.is_currency %}{{ row.diff | default(0) | abs | format_currency }}{% else %}{{ row.diff | default(0) | abs | round(1) }}{% endif %}
        {% if row.diff | default(0) >= 0 %}↑{% else %}↓{% endif %}
      </span>
    </div>
    {% endfor %}
  </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   PRICE POSITION BAR
   Shows subject property position in price range
   Usage: {{ macros.price_position_bar(stats) }}
   ----------------------------------------------------------------------------- #}
{% macro price_position_bar(stats) %}
{% set low = stats.price_low %}
{% set high = stats.price_high %}
{% set subject = stats.piq.price | default(stats.medium.price) %}
{% set range = high - low %}
{% if range > 0 %}
{% set position = ((subject - low) / range * 100) | int %}
<div class="price-position-section">
  <div class="price-position-label">Subject property position in price range</div>
  <div class="price-position-container">
    <div class="price-position-track">
      <div class="price-position-marker" style="left: {{ position }}%">
        <span class="price-position-value">{{ subject | format_currency }}</span>
        <span class="price-position-tick"></span>
      </div>
    </div>
    <div class="price-position-range-labels">
      <span>{{ low | format_currency }}</span>
      <span>{{ high | format_currency }}</span>
    </div>
  </div>
</div>
{% endif %}
{% endmacro %}

{# -----------------------------------------------------------------------------
   CONTENTS ITEM
   Single item for table of contents
   Usage: {{ macros.contents_item(number, title, subtitle) }}
   ----------------------------------------------------------------------------- #}
{% macro contents_item(number, title, subtitle=None) %}
<div class="contents-item">
  <span class="contents-number">{{ '%02d' | format(number) }}</span>
  <div class="contents-text">
    <span class="contents-title">{{ title }}</span>
    {% if subtitle %}
    <span class="contents-subtitle">{{ subtitle }}</span>
    {% endif %}
  </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   AERIAL INFO BAR
   Info bar below aerial map with neighborhood, coordinates, ZIP, county
   Usage: {{ macros.aerial_info_bar(property) }}
   ----------------------------------------------------------------------------- #}
{% macro aerial_info_bar(property) %}
<div class="aerial-info-bar">
  <div class="aerial-info-item">
    <span class="aerial-info-label">Neighborhood</span>
    <span class="aerial-info-value">{{ property.neighborhood | default(property.city) }}</span>
  </div>
  <div class="aerial-info-divider"></div>
  <div class="aerial-info-item">
    <span class="aerial-info-label">Coordinates</span>
    <span class="aerial-info-value">{{ property.latitude }}, {{ property.longitude }}</span>
  </div>
  <div class="aerial-info-divider"></div>
  <div class="aerial-info-item">
    <span class="aerial-info-label">ZIP Code</span>
    <span class="aerial-info-value">{{ property.zip_code }}</span>
  </div>
  <div class="aerial-info-divider"></div>
  <div class="aerial-info-item">
    <span class="aerial-info-label">County</span>
    <span class="aerial-info-value">{{ property.county | default('—') }}</span>
  </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   MAP CARD
   Styled container for map images with optional property marker overlay
   Usage: {{ macros.map_card(image_url, title, property) }}
   ----------------------------------------------------------------------------- #}
{% macro map_card(image_url, title=None, property=None) %}
<div class="map-card">
  {% if title %}
  <div class="map-card-header">{{ title }}</div>
  {% endif %}
  <div class="map-card-image">
    {% if image_url %}
    <img src="{{ image_url }}" alt="{{ title | default('Map') }}">
    {# Property marker overlay #}
    {% if property %}
    <div class="map-marker">
      <span class="map-marker-label">{{ property.street_address }}</span>
      <svg class="map-marker-pin" width="12" height="16" viewBox="0 0 12 16">
        <path d="M6 0C2.7 0 0 2.7 0 6c0 4.5 6 10 6 10s6-5.5 6-10c0-3.3-2.7-6-6-6z" fill="var(--color-accent)"/>
        <circle cx="6" cy="6" r="2.5" fill="white"/>
      </svg>
    </div>
    {% endif %}
    {% else %}
    <div class="map-placeholder">Map not available</div>
    {% endif %}
  </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
   PRICE RANGE BAR
   Visual price range indicator
   Usage: {{ macros.price_range_bar(low, high, subject_estimate) }}
   ----------------------------------------------------------------------------- #}
{% macro price_range_bar(low, high, subject_estimate=None) %}
<div class="price-range-bar">
  <div class="price-range-track">
    {% if subject_estimate %}
    {% set range = high - low %}
    {% set position = ((subject_estimate - low) / range * 100) | int %}
    <div class="price-range-marker" style="left: {{ position }}%">
      <span class="price-range-marker-label">{{ subject_estimate | format_currency }}</span>
    </div>
    {% endif %}
  </div>
  <div class="price-range-labels">
    <span class="price-range-low">{{ low | format_currency }}</span>
    <span class="price-range-high">{{ high | format_currency }}</span>
  </div>
</div>
{% endmacro %}
