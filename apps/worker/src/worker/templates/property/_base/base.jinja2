{# =============================================================================
   BASE PROPERTY REPORT TEMPLATE
   All themes extend this template and override blocks as needed
   
   Page Structure (7 pages):
   1. Cover        - Property hero image, address, agent info
   2. Contents     - Table of contents
   3. Aerial       - Aerial/satellite map view
   4. Property     - Property details and tax info
   5. Analysis     - Market analysis summary
   6. Comparables  - Comparable sales grid
   7. Range        - Price range visualization
   ============================================================================= #}

{% import '_base/_macros.jinja2' as macros %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property Report - {{ property.full_address }}</title>
  
  {# Phase 4.3: Font preconnect — reduces Google Fonts DNS + TLS latency
     Must come BEFORE the fonts block so the browser resolves the connection
     before the theme's <link> tags fire. #}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  {# Theme-specific fonts #}
  {% block fonts %}{% endblock %}
  
  <style>
    {# =========================================================================
       BASE STYLES - Shared across all themes
       ========================================================================= #}
    
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      /* Page Dimensions - DO NOT CHANGE */
      --page-width: 8.5in;
      --page-height: 11in;
      
      /* Standardized Spacing - All themes use these */
      --page-margin: 0.5in;
      --footer-height: 0.6in;
      --footer-bottom: 0.4in;

      /* Page Geometry - Locked dimensions */
      --page-header-height: 1.1in;   /* Min header height — used as min-height, not fixed */
      --content-area-height: calc(
        var(--page-height)
        - var(--page-margin)
        - var(--page-header-height)
        - var(--space-lg)
        - var(--footer-height)
        - var(--footer-bottom)
      );  /* ≈ 8.15in — usable vertical budget per page, below header, above footer */
      
      /* Spacing Scale */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 40px;
      --space-2xl: 60px;
      
      /* Base Border Radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-full: 9999px;
      
      /* Theme Variables - Override in each theme */
      --color-primary: #1a1a1a;
      --color-primary-light: #333333;
      --color-accent: #666666;
      --color-accent-light: #888888;
      --color-background: #ffffff;
      --color-surface: #f5f5f5;
      --color-text: #1a1a1a;
      --color-text-muted: #666666;
      --color-border: #e5e5e5;
      
      --font-display: system-ui, sans-serif;
      --font-body: system-ui, sans-serif;
      
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
    }
    
    html {
      font-size: 16px;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    body {
      font-family: var(--font-body);
      color: var(--color-text);
      background: #e5e5e5;
      line-height: 1.5;
    }
    
    img {
      max-width: 100%;
      height: auto;
    }
    
    {# =========================================================================
       PAGE STRUCTURE
       ========================================================================= #}
    
    .sheet {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      gap: 40px;
    }
    
    .page {
      width: var(--page-width);
      height: var(--page-height);
      background: var(--color-background);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }
    
    .page-content {
      position: absolute;
      top: var(--page-margin);
      left: var(--page-margin);
      right: var(--page-margin);
      bottom: calc(var(--footer-height) + var(--footer-bottom));
      overflow: hidden;
    }
    
    .page-content--full {
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    {# =========================================================================
       PAGE HEADER COMPONENT
       ========================================================================= #}
    
    .page-header {
      min-height: var(--page-header-height);
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 2px solid var(--color-border);
    }
    
    .page-title {
      font-family: var(--font-display);
      font-size: 28px;
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1.2;
      margin-bottom: var(--space-xs);
    }
    
    .page-subtitle {
      font-size: 13px;
      color: var(--color-text-muted);
    }
    
    .page-header-accent {
      width: 60px;
      height: 3px;
      background: var(--color-accent);
      margin-top: var(--space-sm);
    }
    
    {# =========================================================================
       PAGE FOOTER COMPONENT
       ========================================================================= #}
    
    .page-footer {
      position: absolute;
      bottom: var(--footer-bottom);
      left: var(--page-margin);
      right: var(--page-margin);
      height: var(--footer-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      /* border removed — clean footer without divider line */
    }
    
    .footer-left {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .footer-agent-photo {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      object-fit: cover;
      border: 2px solid var(--color-accent);
    }
    
    .footer-agent-photo--placeholder {
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-display);
      font-weight: 600;
      font-size: 14px;
    }
    
    .footer-agent-info {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    
    .footer-agent-name {
      font-family: var(--font-display);
      font-size: 12px;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .footer-agent-contact {
      font-size: 10px;
      color: var(--color-text-muted);
    }
    
    .footer-right {
      display: flex;
      align-items: center;
    }
    
    .footer-logo {
      max-height: 40px;
      max-width: 140px;
      object-fit: contain;
    }
    
    .footer-company {
      font-family: var(--font-display);
      font-size: 12px;
      font-weight: 600;
      color: var(--color-primary);
    }
    
    {# =========================================================================
       COVER FOOTER (Agent Block)
       ========================================================================= #}
    
    .cover-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-background);
      padding: var(--space-lg) var(--page-margin);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .cover-agent {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .cover-agent-photo {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-full);
      object-fit: cover;
      border: 3px solid var(--color-accent);
    }
    
    .cover-agent-photo--placeholder {
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 24px;
    }
    
    .cover-agent-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .cover-agent-name {
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .cover-agent-title {
      font-size: 12px;
      color: var(--color-text-muted);
    }
    
    .cover-agent-contact {
      font-size: 12px;
      color: var(--color-text);
      font-weight: 500;
    }
    
    .cover-branding {
      display: flex;
      align-items: center;
    }
    
    .cover-logo {
      max-height: 50px;
      max-width: 180px;
      object-fit: contain;
    }
    
    .cover-company-text {
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .cover-company-name {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 600;
      color: var(--color-primary);
    }
    
    .cover-company-tagline {
      font-size: 11px;
      color: var(--color-text-muted);
    }
    
    {# =========================================================================
       DATA TABLES
       ========================================================================= #}
    
    .table-title {
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 600;
      color: var(--color-primary);
      margin-bottom: var(--space-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .data-table tr {
      border-bottom: 1px solid var(--color-border);
    }
    
    .data-table tr:last-child {
      border-bottom: none;
    }
    
    .data-table td {
      padding: 10px 0;
    }
    
    .data-label {
      color: var(--color-text-muted);
      width: 40%;
    }
    
    .data-value {
      color: var(--color-text);
      font-weight: 500;
    }
    
    {# =========================================================================
       PROPERTY STATS
       ========================================================================= #}
    
    .property-stats {
      display: flex;
      gap: var(--space-xl);
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .stat-value {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .stat-label {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--color-text-muted);
    }
    
    {# =========================================================================
       KEY STATS BAR (Property Details Page)
       ========================================================================= #}
    
    .key-stats-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      margin-bottom: 18px;
      background: var(--color-primary);
      border-radius: var(--radius-lg);
    }
    
    .key-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .key-stat-value {
      font-family: var(--font-display);
      font-size: 22px;
      font-weight: 700;
      color: white;
      line-height: 1;
    }
    
    .key-stat-label {
      font-family: var(--font-body);
      font-size: 8px;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 2px;
    }
    
    .key-stat-divider {
      width: 1px;
      height: 28px;
      background: rgba(255,255,255,0.15);
    }
    
    {# =========================================================================
       COMP CARDS
       ========================================================================= #}
    
    .comp-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
    }
    
    .comp-card {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .comp-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) var(--space-md);
      background: var(--color-primary);
      color: white;
    }
    
    .comp-number {
      font-family: var(--font-display);
      font-size: 12px;
      font-weight: 600;
      opacity: 0.7;
    }
    
    .comp-price {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 700;
    }
    
    .comp-image {
      height: 170px;
      overflow: hidden;
    }
    
    .comp-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .comp-details {
      padding: var(--space-md);
    }
    
    .comp-address {
      font-family: var(--font-display);
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-xs);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .comp-meta {
      font-size: 11px;
      color: var(--color-text-muted);
      margin-bottom: var(--space-sm);
    }
    
    .comp-meta-divider {
      margin: 0 4px;
      opacity: 0.5;
    }
    
    .comp-stats {
      display: flex;
      gap: var(--space-md);
    }
    
    .comp-stat {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    
    .comp-stat-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .comp-stat-label {
      font-size: 9px;
      color: var(--color-text-muted);
      text-transform: uppercase;
    }
    
    {# =========================================================================
       ANALYSIS COMPONENTS
       ========================================================================= #}
    
    .analysis-summary {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
    }
    
    .analysis-range {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-lg);
      border-bottom: 1px solid var(--color-border);
    }
    
    .range-item {
      text-align: center;
    }
    
    .range-label {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xs);
    }
    
    .range-value {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 700;
      color: var(--color-text);
    }
    
    .range-median .range-value {
      color: var(--color-accent);
    }
    
    .analysis-stats {
      display: flex;
      justify-content: space-around;
    }
    
    .analysis-stat {
      text-align: center;
    }
    
    .analysis-stat-value {
      display: block;
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      color: var(--color-primary);
    }
    
    .analysis-stat-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-muted);
    }
    
    {# =========================================================================
       COMPARISON TABLE
       ========================================================================= #}
    
    .comparison-section { margin-top: 16px; }
    
    .section-title {
      font-family: var(--font-display);
      font-size: 13px;
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: 8px;
    }
    
    .comparison-table {
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--color-border);
    }
    
    .comparison-header {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      padding: 8px 12px;
      background: var(--color-primary);
      font-family: var(--font-body);
      font-size: 9px;
      font-weight: 700;
      color: white;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .comparison-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      padding: 7px 12px;
      font-size: 10px;
    }
    
    .comparison-row-stripe {
      background: var(--color-surface);
    }
    
    .comparison-metric {
      font-family: var(--font-body);
      font-weight: 600;
      color: var(--color-primary);
    }
    
    .comparison-subject {
      font-family: var(--font-body);
      color: var(--color-text);
    }
    
    .comparison-comp {
      font-family: var(--font-body);
      color: var(--color-text-muted);
    }
    
    .comparison-diff {
      font-family: var(--font-body);
      font-weight: 700;
    }
    
    .diff-positive { color: #16A34A; }
    .diff-negative { color: #DC2626; }
    
    {# =========================================================================
       PRICE POSITION BAR
       ========================================================================= #}
    
    .price-position-section { margin-top: 4px; }
    
    .price-position-label {
      font-family: var(--font-body);
      font-size: 9px;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }
    
    .price-position-container {
      position: relative;
      height: 36px;
    }
    
    .price-position-track {
      position: absolute;
      top: 12px;
      left: 0;
      right: 0;
      height: 12px;
      border-radius: var(--radius-sm);
      background: linear-gradient(90deg, var(--color-border) 0%, var(--color-accent) 100%);
    }
    
    .price-position-marker {
      position: absolute;
      top: -12px;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .price-position-value {
      font-family: var(--font-body);
      font-size: 8px;
      font-weight: 700;
      color: var(--color-primary);
      white-space: nowrap;
      margin-bottom: 1px;
    }
    
    .price-position-tick {
      display: block;
      width: 3px;
      height: 24px;
      background: var(--color-primary);
      border-radius: 2px;
    }
    
    .price-position-range-labels {
      position: absolute;
      bottom: -14px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      font-family: var(--font-body);
      font-size: 8px;
      color: var(--color-text-muted);
    }
    
    {# =========================================================================
       CONTENTS PAGE
       ========================================================================= #}
    
    .contents-layout {
      display: flex;
    }
    
    .contents-sidebar-accent {
      width: 3px;
      background: var(--color-accent);
      margin-right: 24px;
      opacity: 0.4;
      border-radius: 2px;
    }
    
    .contents-main {
      flex: 1;
    }
    
    .contents-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }
    
    .contents-item {
      display: flex;
      align-items: baseline;
      gap: var(--space-md);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }
    
    .contents-number {
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 600;
      color: var(--color-accent);
      min-width: 30px;
    }
    
    .contents-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .contents-title {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .contents-subtitle {
      font-size: 12px;
      color: var(--color-text-muted);
    }
    
    {# =========================================================================
       MAP CARD
       ========================================================================= #}
    
    .map-card {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .map-card-header {
      padding: var(--space-md);
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 600;
      color: var(--color-primary);
      background: var(--color-background);
      border-bottom: 1px solid var(--color-border);
    }
    
    .map-card-image {
      height: 400px;
      position: relative;
    }
    
    .map-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .map-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-surface);
      color: var(--color-text-muted);
      font-size: 14px;
    }
    
    /* Aerial map marker overlay */
    .map-marker {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -100%);
      z-index: 5;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .map-marker-label {
      font-family: var(--font-body);
      font-size: 9px;
      font-weight: 700;
      color: white;
      background: var(--color-accent);
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      white-space: nowrap;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .map-marker-pin {
      margin-top: -1px;
    }
    
    /* Aerial info bar */
    .aerial-info-bar {
      display: flex;
      align-items: stretch;         /* children fill full bar height */
      justify-content: space-between;
      margin-top: 16px;
      padding: 0;                   /* padding moved to items */
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      min-height: 72px;             /* taller bar */
    }
    
    .aerial-info-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 18px 24px;           /* was 0 — now items are tall boxes */
      flex: 1;
    }
    
    .aerial-info-label {
      font-family: var(--font-body);
      font-size: 9px;               /* was 8px */
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;           /* was 2px */
    }
    
    .aerial-info-value {
      font-family: var(--font-display);
      font-size: 14px;              /* was 12px */
      font-weight: 700;
      color: var(--color-primary);
    }
    
    .aerial-info-divider {
      width: 1px;
      align-self: stretch;
      background: var(--color-border);
      flex-shrink: 0;
    }
    
    {# =========================================================================
       PRICE RANGE BAR
       ========================================================================= #}
    
    .price-range-bar {
      margin: var(--space-lg) 0;
    }
    
    .price-range-track {
      height: 8px;
      background: linear-gradient(90deg, var(--color-surface) 0%, var(--color-accent) 50%, var(--color-surface) 100%);
      border-radius: var(--radius-full);
      position: relative;
    }
    
    .price-range-marker {
      position: absolute;
      top: -30px;
      transform: translateX(-50%);
    }
    
    .price-range-marker::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 38px;
      background: var(--color-primary);
    }
    
    .price-range-marker-label {
      background: var(--color-primary);
      color: white;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-family: var(--font-display);
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .price-range-labels {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-sm);
      font-size: 12px;
      color: var(--color-text-muted);
    }
    
    {# =========================================================================
       RANGE PAGE — ENHANCED
       ========================================================================= #}
    
    /* Range bar container */
    .range-bar-container {
      padding: 20px;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      margin-bottom: 16px;
    }
    
    .range-bar-label {
      font-family: var(--font-body);
      font-size: 9px;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
    }
    
    .range-bar-visual {
      position: relative;
      height: 56px;
      margin-bottom: 8px;
    }
    
    .range-bar-track {
      position: absolute;
      top: 26px;
      left: 0;
      right: 0;
      height: 16px;
      border-radius: var(--radius-sm);
      background: linear-gradient(90deg, var(--color-border) 0%, var(--color-accent) 100%);
    }
    
    .range-bar-dot {
      position: absolute;
      top: 3px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--color-primary);
      transform: translateX(-50%);
      z-index: 2;
    }
    
    .range-bar-subject {
      position: absolute;
      top: -26px;
      transform: translateX(-50%);
      z-index: 3;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .range-bar-subject-label {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 700;
      color: var(--color-accent);
      white-space: nowrap;
      margin-bottom: 2px;
    }
    
    .range-bar-subject-arrow {
      display: block;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid var(--color-accent);
    }
    
    .range-bar-endpoints {
      position: absolute;
      bottom: -4px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      font-family: var(--font-body);
      font-size: 9px;
      color: var(--color-text-muted);
    }
    
    /* Range comps with mini bars */
    .range-comps-section { margin-bottom: 16px; }
    
    .range-comp-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
    }
    
    .range-comp-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-accent);
      flex-shrink: 0;
    }
    
    .range-comp-address {
      flex: 1;
      font-family: var(--font-body);
      font-size: 10px;
      font-weight: 600;
      color: var(--color-primary);
    }
    
    .range-comp-distance {
      font-family: var(--font-body);
      font-size: 9px;
      color: var(--color-text-muted);
      min-width: 50px;
      text-align: center;
    }
    
    .range-comp-price {
      font-family: var(--font-display);
      font-size: 12px;
      font-weight: 700;
      color: var(--color-primary);
      min-width: 90px;
      text-align: right;
    }
    
    .range-comp-minibar {
      position: relative;
      width: 60px;
      height: 6px;
      background: var(--color-border);
      border-radius: 3px;
      flex-shrink: 0;
    }
    
    .range-comp-minibar-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      border-radius: 3px;
      background: var(--color-accent);
      opacity: 0.7;
    }
    
    /* Range stats grid */
    .range-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .range-stat-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
    }
    
    .range-stat-value {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1;
    }
    
    .range-stat-label {
      font-family: var(--font-body);
      font-size: 7px;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 3px;
      text-align: center;
    }
    
    /* Market insight */
    .market-insight {
      padding: 14px 16px;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
    }
    
    .market-insight-title {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 700;
      color: var(--color-primary);
      margin: 0 0 6px 0;
    }
    
    .market-insight-text {
      font-family: var(--font-body);
      font-size: 10px;
      color: var(--color-text-muted);
      line-height: 1.6;
      margin: 0;
    }

    {# =========================================================================
       MARKET TRENDS PAGE — Shared styles (inherited by all 5 themes via CSS vars)
       
       Design principles:
       - Colors via CSS vars (--color-primary, --font-display, --font-body)
         so all 5 themes inherit brand personality automatically.
       - Sentiment coloring (good/bad/neutral) is INDEPENDENT of direction.
         Template uses .mt-card-change--good/bad, not direction arrows, for color.
       - Gauge marker sits OUTSIDE .mt-gauge-bar (overflow:hidden) but INSIDE
         .mt-gauge-container (position:relative) to avoid clipping at rounded ends.
       ========================================================================= #}

    /* ── Market Trends page — flex column so sections fill the page ──────── */
    .page-market-trends .page-content {
      display: flex;
      flex-direction: column;
    }
    /* Gauge section grows to consume remaining vertical space */
    .mt-gauge-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* ── Page header ─────────────────────────────────────────────────────── */
    .mt-header {
      margin-bottom: 22px;          /* was 14px */
    }
    .mt-title {
      font-family: var(--font-display);
      font-size: 26px;
      font-weight: 700;
      color: var(--color-primary);
      margin: 0 0 2px 0;
      line-height: 1.2;
    }
    .mt-subtitle {
      font-family: var(--font-body);
      font-size: 11px;
      color: var(--color-text-muted);
      margin: 0;
      letter-spacing: 0.2px;
    }
    .mt-header-accent {
      width: 48px;
      height: 3px;
      background: var(--color-accent);
      margin-top: 8px;              /* was 6px */
      border-radius: 2px;
    }

    /* ── Market condition badge ───────────────────────────────────────────── */
    .mt-condition {
      border-radius: var(--radius-md);
      padding: 18px 20px;           /* was 12px 16px */
      margin-bottom: 22px;          /* was 14px */
      display: flex;
      align-items: flex-start;
      gap: 16px;                    /* was 14px */
    }
    .mt-condition--sellers {
      background: rgba(22, 163, 74, 0.05);
      border: 1px solid rgba(22, 163, 74, 0.25);
    }
    .mt-condition--balanced {
      background: rgba(234, 179, 8, 0.05);
      border: 1px solid rgba(234, 179, 8, 0.3);
    }
    .mt-condition--buyers {
      background: rgba(220, 38, 38, 0.05);
      border: 1px solid rgba(220, 38, 38, 0.2);
    }
    .mt-condition--unknown {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
    }
    .mt-condition-left {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 100px;
    }
    .mt-condition-label {
      font-family: var(--font-display);
      font-size: 13px;
      font-weight: 700;
      color: var(--color-primary);
      white-space: nowrap;
    }
    .mt-condition-score {
      display: flex;
      gap: 3px;
    }
    .mt-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--color-border);
      display: inline-block;
      flex-shrink: 0;
    }
    .mt-dot--filled {
      background: var(--color-accent);
    }
    .mt-condition-desc {
      font-family: var(--font-body);
      font-size: 9.5px;
      color: var(--color-text-muted);
      line-height: 1.5;
      margin: 0;
    }

    /* ── Metrics grid — 3 × 2 ────────────────────────────────────────────── */
    .mt-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;                    /* was 9px */
      margin-bottom: 22px;          /* was 14px */
    }
    .mt-card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 16px 14px;           /* was 10px 12px */
      text-align: center;
      background: var(--color-surface);
      display: flex;
      flex-direction: column;
      gap: 3px;                     /* was 2px */
    }
    .mt-card-label {
      font-family: var(--font-body);
      font-size: 8px;               /* was 7.5px */
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--color-text-muted);
    }
    .mt-card-value {
      font-family: var(--font-display);
      font-size: 22px;              /* was 20px */
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1.15;
    }
    .mt-card-value--na {
      color: var(--color-border);
      font-size: 16px;
    }
    .mt-card-note {
      font-family: var(--font-body);
      font-size: 8px;
      color: var(--color-text-muted);
    }

    /* Trend change — colored by SENTIMENT, not direction */
    .mt-card-change {
      font-family: var(--font-body);
      font-size: 8.5px;             /* was 8px */
      color: var(--color-text-muted);
      font-weight: 500;
    }
    .mt-card-change--good    { color: #16a34a; }
    .mt-card-change--bad     { color: #dc2626; }
    .mt-card-change--neutral { color: var(--color-text-muted); }

    /* ── Inventory gauge — flex: 1 override applied above this block ─────── */
    .mt-gauge-label {
      font-family: var(--font-body);
      font-size: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--color-text-muted);
      margin-bottom: 18px;          /* Space for marker above bar */
    }
    .mt-gauge-container {
      position: relative;           /* Marker positions relative to THIS */
    }
    .mt-gauge-bar {
      height: 22px;
      border-radius: var(--radius-full);
      display: flex;
      overflow: hidden;             /* Clips zone colors — marker is OUTSIDE */
    }
    .mt-gauge-zone {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-body);
      font-size: 7px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: rgba(255, 255, 255, 0.9);
    }
    .mt-gauge-zone--sellers  { background: #16a34a; }
    .mt-gauge-zone--balanced { background: #ca8a04; }
    .mt-gauge-zone--buyers   { background: #dc2626; }
    /* Gauge marker — OUTSIDE the clipping bar, inside the container */
    .mt-gauge-marker {
      position: absolute;
      top: -28px;                   /* Above the bar, within container padding */
      transform: translateX(-50%);
      text-align: center;
      z-index: 2;
      pointer-events: none;
    }
    .mt-gauge-pip {
      display: block;
      font-size: 11px;
      color: var(--color-primary);
      line-height: 1;
      margin-bottom: 1px;
    }
    .mt-gauge-val {
      display: inline-block;
      background: var(--color-primary);
      color: white;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-family: var(--font-display);
      font-size: 9px;
      font-weight: 700;
      white-space: nowrap;
    }
    .mt-gauge-tick-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-family: var(--font-body);
      font-size: 7px;
      color: var(--color-text-muted);
    }

    /* ── Attribution ─────────────────────────────────────────────────────── */
    .mt-attribution {
      padding-top: 14px;            /* was 10px */
      border-top: 1px solid var(--color-border);
      margin-top: 22px;             /* push away from gauge */
    }
    .mt-attribution p {
      font-family: var(--font-body);
      font-size: 7px;
      color: var(--color-text-muted);
      margin: 0 0 2px 0;
      line-height: 1.4;
    }

    {# Per-theme market-trends CSS overrides live here — each theme can inject
       additional brand personality without touching the shared layout above. #}
    {% block market_trends_css %}{% endblock %}
    
    {# =========================================================================
       TWO COLUMN LAYOUT
       ========================================================================= #}
    
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xl);
    }
    
    .two-column > * {
      min-width: 0;
    }
    
    {# =========================================================================
       PAGE 4: COMPACT DATA TABLES
       Single-column layout packs 21 data rows — scope under .page-property
       so higher specificity overrides all theme padding overrides.
       ========================================================================= #}

    .page-property .data-table {
      font-size: 11px;
    }

    .page-property .data-table td {
      padding: 5px 10px;
    }

    .page-property .table-title {
      padding: 7px 10px;
    }

    .page-property .table-section + .table-section {
      margin-top: 14px;
    }

    {# =========================================================================
       PRINT STYLES
       ========================================================================= #}
    
    @page {
      size: Letter;
      margin: 0;
    }
    
    @media print {
      html, body {
        background: white;
        margin: 0;
        padding: 0;
      }
      
      .sheet {
        padding: 0;
        gap: 0;
      }
      
      .page {
        box-shadow: none;
        page-break-after: always;
        page-break-inside: avoid;
      }
      
      .page:last-child {
        page-break-after: auto;
      }
    }
    
    {# =========================================================================
       THEME-SPECIFIC STYLES
       Override these in each theme
       ========================================================================= #}
    {% block theme_styles %}{% endblock %}
  </style>
</head>
<body>
  {# Force font rendering before PDF capture — ensures all Google Fonts are loaded
     and rasterized, preventing fallback to generic serif/sans-serif in PDF output. #}
  <div style="position:absolute;left:-9999px;top:-9999px;opacity:0;pointer-events:none;" aria-hidden="true">
    <span style="font-family:var(--font-display);font-weight:400;">.</span>
    <span style="font-family:var(--font-display);font-weight:500;">.</span>
    <span style="font-family:var(--font-display);font-weight:600;">.</span>
    <span style="font-family:var(--font-display);font-weight:700;">.</span>
    <span style="font-family:var(--font-body);font-weight:400;">.</span>
    <span style="font-family:var(--font-body);font-weight:500;">.</span>
    <span style="font-family:var(--font-body);font-weight:600;">.</span>
    <span style="font-family:var(--font-body);font-weight:700;">.</span>
  </div>
  <div class="sheet">
    
    {# =========================================================================
       PAGE 1: COVER
       ========================================================================= #}
    <div class="page page-cover">
      {% block cover %}
      <div class="page-content page-content--full">
        <div class="cover-bg" style="background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%){% if images.hero %}, url('{{ images.hero }}') center/cover{% endif %};"></div>
        <div class="cover-content">
          <div class="cover-property-type">{{ property.property_type | default('Residential') }}</div>
          <h1 class="cover-address">{{ property.street_address }}</h1>
          <p class="cover-location">{{ property.city }}, {{ property.state }} {{ property.zip_code }}</p>
          <div class="cover-accent-line"></div>
          {{ macros.property_stats(property) }}
        </div>
        {{ macros.cover_agent_block(agent) }}
      </div>
      {% endblock %}
    </div>
    
    {# =========================================================================
       PAGE 2: CONTENTS
       Dynamic page numbers — computed from which pages are in page_set.
       Page order is fixed; active pages get sequential numbers.
       ========================================================================= #}
    <div class="page page-contents">
      {% block contents %}
      {# Define canonical page order and display metadata #}
      {% set _page_meta = {
        "cover":         {"name": "Cover",              "sub": property.street_address},
        "contents":      {"name": "Contents",           "sub": "Report Overview"},
        "aerial":        {"name": "Aerial View",        "sub": "Property Location Map"},
        "property":      {"name": "Property Details",   "sub": "Specifications & Tax Information"},
        "analysis":      {"name": "Area Sales Analysis","sub": "Market Statistics"},
        "market_trends": {"name": "Market Trends",      "sub": "Pricing, Inventory & Conditions"},
        "comparables":   {"name": "Sales Comparables",  "sub": "Recent Comparable Sales"},
        "range":         {"name": "Range of Sales",     "sub": "Price Range Analysis"},
      } %}
      {% set _page_order = ["cover","contents","aerial","property","analysis","market_trends","comparables","range"] %}
      <div class="page-content contents-layout">
        <div class="contents-sidebar-accent"></div>
        <div class="contents-main">
          {{ macros.page_header('Contents', 'Property Report Overview') }}
          <div class="contents-list">
            {% set _num = namespace(v=1) %}
            {% for _pid in _page_order %}
              {% if _pid in page_set and _pid in _page_meta %}
                {{ macros.contents_item(_num.v, _page_meta[_pid].name, _page_meta[_pid].sub) }}
                {% set _num.v = _num.v + 1 %}
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
      {{ macros.page_footer(agent, 2) }}
      {% endblock %}
    </div>
    
    {# =========================================================================
       PAGE 3: AERIAL VIEW
       ========================================================================= #}
    <div class="page page-aerial">
      {% block aerial %}
      <div class="page-content">
        {{ macros.page_header('Aerial View', property.full_address) }}
        {{ macros.map_card(images.aerial_map, 'Property Location', property) }}
        {{ macros.aerial_info_bar(property) }}
      </div>
      {{ macros.page_footer(agent, 3) }}
      {% endblock %}
    </div>
    
    {# =========================================================================
       PAGE 4: PROPERTY DETAILS
       ========================================================================= #}
    <div class="page page-property">
      {% block property_details %}
      <div class="page-content">
        {{ macros.page_header('Property Details', property.full_address) }}
        {{ macros.property_key_stats_bar(property) }}
        <div class="table-section">{{ macros.property_details_table(property) }}</div>
        <div class="table-section">{{ macros.school_table(property) }}</div>
        <div class="table-section">{{ macros.tax_table(property) }}</div>
        <div class="table-section">{{ macros.location_table(property) }}</div>
      </div>
      {{ macros.page_footer(agent, 4) }}
      {% endblock %}
    </div>
    
    {# =========================================================================
       PAGE 5: AREA SALES ANALYSIS
       ========================================================================= #}
    <div class="page page-analysis">
      {% block analysis %}
      <div class="page-content">
        {{ macros.page_header('Area Sales Analysis', 'Comparable market statistics and pricing') }}
        {{ macros.analysis_summary(stats, property) }}
        {{ macros.price_position_bar(stats) }}
        {{ macros.comparison_table(stats, property) }}
        {{ macros.market_metrics_block(market_trends) }}
      </div>
      {{ macros.page_footer(agent, 5) }}
      {% endblock %}
    </div>
    
    {# =========================================================================
       PAGE 6: MARKET TRENDS  (optional — only rendered when in page_set AND
               market_trends context is populated with sufficient data)
       ========================================================================= #}
    {% if "market_trends" in page_set and market_trends %}
    {% block market_trends_page %}
    <div class="page page-market-trends">
      <div class="page-content">
        {% block market_trends_content %}

        {# ── Page Header ───────────────────────────────────────────────────── #}
        <div class="mt-header">
          <h1 class="mt-title">Market Trends</h1>
          <p class="mt-subtitle">
            {{ market_trends.city }}
            {% if market_trends.city %} · {% endif %}
            {{ market_trends.period_label }}
            {% if not market_trends.has_prior_data %}
            <span style="color: #ca8a04;"> · Current period only (prior comparison unavailable)</span>
            {% endif %}
          </p>
          <div class="mt-header-accent"></div>
        </div>

        {# ── Market Condition Badge ─────────────────────────────────────────── #}
        <div class="mt-condition mt-condition--{{ market_trends.market_condition.indicator }}">
          <div class="mt-condition-left">
            <span class="mt-condition-label">{{ market_trends.market_condition.label }}</span>
            {{ macros.condition_dots(market_trends.market_condition.score) }}
          </div>
          <p class="mt-condition-desc">{{ market_trends.market_condition.description }}</p>
        </div>

        {# ── Metrics Grid (3 × 2) ───────────────────────────────────────────── #}
        <div class="mt-grid">
          {{ macros.trend_card("Median Sale Price",       market_trends.median_sale_price,    market_trends.has_prior_data) }}
          {{ macros.trend_card("Avg Days on Market",      market_trends.avg_days_on_market,   market_trends.has_prior_data) }}
          {{ macros.trend_card("List-to-Sale Ratio",      market_trends.list_to_sale_ratio,   market_trends.has_prior_data) }}
          {{ macros.trend_card("Price per Sq Ft",         market_trends.price_per_sqft,       market_trends.has_prior_data) }}
          {{ macros.trend_card("Closed Sales (90 Days)",  market_trends.closed_sales,         market_trends.has_prior_data) }}

          {# Active Listings — snapshot only, no trend arrow #}
          <div class="mt-card">
            <div class="mt-card-label">Active Listings</div>
            <div class="mt-card-value">{{ market_trends.active_listings.formatted_count }}</div>
            <div class="mt-card-note">Avg {{ market_trends.active_listings.formatted_avg_price }}</div>
          </div>
        </div>

        {# ── Months of Inventory Gauge ───────────────────────────────────────── #}
        {% if market_trends.months_of_inventory.current is not none %}
        <div class="mt-gauge-wrap">
          <div class="mt-gauge-label">Months of Inventory</div>
          <div class="mt-gauge-container">
            {# Bar with colored zones: overflow:hidden clips at rounded edges #}
            <div class="mt-gauge-bar">
              <div class="mt-gauge-zone mt-gauge-zone--sellers">Seller's<br>&lt; 4 mo</div>
              <div class="mt-gauge-zone mt-gauge-zone--balanced">Balanced<br>4 – 6 mo</div>
              <div class="mt-gauge-zone mt-gauge-zone--buyers">Buyer's<br>&gt; 6 mo</div>
            </div>
            {# Marker OUTSIDE the bar — not clipped by overflow:hidden above #}
            <div class="mt-gauge-marker" style="left: {{ market_trends.months_of_inventory.gauge_pct | default(50) }}%;">
              <span class="mt-gauge-pip">▼</span>
              <span class="mt-gauge-val">{{ market_trends.months_of_inventory.formatted_current }}</span>
            </div>
          </div>
          <div class="mt-gauge-tick-labels">
            <span>0 mo</span>
            <span>3 mo</span>
            <span>6 mo</span>
            <span>9 mo</span>
            <span>12 mo+</span>
          </div>
        </div>
        {% endif %}

        {# ── Data Attribution (MLS compliance) ─────────────────────────────── #}
        <div class="mt-attribution">
          <p>
            Data source: {{ market_trends.data_source }} ·
            {{ market_trends.city }} ·
            {{ market_trends.period_label }} ·
            {{ market_trends.sample_size }} closed sales analyzed ·
            Generated {{ market_trends.generated_date }}
          </p>
          <p>Market conditions change rapidly. Consult your real estate professional for current, personalized advice.</p>
        </div>

        {% endblock market_trends_content %}
      </div>
      {{ macros.page_footer(agent) }}
    </div>
    {% endblock market_trends_page %}
    {% endif %}

    {# =========================================================================
       PAGE 6/7: SALES COMPARABLES
       ========================================================================= #}
    <div class="page page-comparables">
      {% block comparables %}
      <div class="page-content">
        {{ macros.page_header('Sales Comparables', 'Recent Comparable Sales') }}
        {{ macros.comp_grid(comparables, confidence_grade=comp_confidence_grade, confidence_reason=comp_confidence_reason) }}
      </div>
      {{ macros.page_footer(agent, 6) }}
      {% endblock %}
    </div>
    
    {# =========================================================================
       PAGE 7: RANGE OF SALES
       ========================================================================= #}
    <div class="page page-range">
      {% block range %}
      <div class="page-content">
        {{ macros.page_header('Range of Sales', 'Price positioning and market insight') }}

        {# Visual Price Range Bar with comp markers #}
        <div class="range-bar-container">
          <div class="range-bar-label">Estimated Value Position</div>
          <div class="range-bar-visual">
            <div class="range-bar-track">
              {# Comp dot markers #}
              {% for comp in comparables[:4] %}
              {% set comp_price = (comp.sale_price or comp.list_price or 0) | float %}
              {% set range_low = stats.price_low | default(0, true) | float %}
              {% set range_high = stats.price_high | default(0, true) | float %}
              {% if range_high != range_low and comp_price > 0 %}
              {% set pct = ((comp_price - range_low) / (range_high - range_low) * 100) | int %}
              <div class="range-bar-dot" style="left: {{ pct }}%"></div>
              {% endif %}
              {% endfor %}
              {# Subject marker #}
              {% set subj_price = stats.piq.price | default(0, true) | float %}
              {% set range_low = stats.price_low | default(0, true) | float %}
              {% set range_high = stats.price_high | default(0, true) | float %}
              {% if range_high != range_low and subj_price > 0 %}
              {% set subject_pct = ((subj_price - range_low) / (range_high - range_low) * 100) | int %}
              <div class="range-bar-subject" style="left: {{ subject_pct }}%">
                <span class="range-bar-subject-label">{{ stats.piq.price | format_currency }}</span>
                <span class="range-bar-subject-arrow"></span>
              </div>
              {% endif %}
            </div>
            <div class="range-bar-endpoints">
              <span>{{ stats.price_low | format_currency }}</span>
              <span>{{ stats.price_high | format_currency }}</span>
            </div>
          </div>
        </div>

        {# Comparable Sales Summary with mini position bars #}
        <div class="range-comps-section">
          <h3 class="section-title">Comparable Sales Summary</h3>
          <div class="range-comps-list">
            {% for comp in comparables[:4] | sort(attribute='sale_price') %}
            {% set comp_sp = (comp.sale_price or comp.list_price or 0) | float %}
            {% set r_low = stats.price_low | default(0, true) | float %}
            {% set r_high = stats.price_high | default(0, true) | float %}
            {% if r_high != r_low and comp_sp > 0 %}
            {% set pct = ((comp_sp - r_low) / (r_high - r_low) * 100) | int %}
            {% else %}
            {% set pct = 50 %}
            {% endif %}
            <div class="range-comp-item">
              <span class="range-comp-dot"></span>
              <span class="range-comp-address">{{ comp.address }}</span>
              <span class="range-comp-distance">{{ comp.distance_miles }} mi</span>
              <span class="range-comp-price">{{ comp.sale_price | format_currency }}</span>
              <div class="range-comp-minibar">
                <div class="range-comp-minibar-fill" style="width: {{ pct }}%"></div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        {# Summary Statistics Grid #}
        <div class="range-stats-grid">
          <div class="range-stat-card">
            <span class="range-stat-value">{{ stats.avg_price_per_sqft | format_currency }}</span>
            <span class="range-stat-label">Avg $/Sq Ft</span>
          </div>
          <div class="range-stat-card">
            <span class="range-stat-value">{{ stats.avg_days_on_market | default('—') }}</span>
            <span class="range-stat-label">Avg Days on Market</span>
          </div>
          <div class="range-stat-card">
            <span class="range-stat-value">{{ stats.active_listings | default('—') }}</span>
            <span class="range-stat-label">Active Listings</span>
          </div>
          <div class="range-stat-card">
            <span class="range-stat-value">{{ stats.total_comps }}</span>
            <span class="range-stat-label">Comparables</span>
          </div>
        </div>

        {# Market Insight #}
        <div class="market-insight">
          <h4 class="market-insight-title">Market Insight</h4>
          <p class="market-insight-text">
            Based on {{ stats.total_comps }} comparable sales{% if stats.max_distance %} within {{ stats.max_distance }} miles{% endif %}, the estimated market value for this property falls between {{ stats.price_low | format_currency }} and {{ stats.price_high | format_currency }}. The median comparable sold at {{ stats.medium.price | format_currency }}, suggesting strong market positioning.
          </p>
        </div>
      </div>
      {{ macros.page_footer(agent, 7) }}
      {% endblock %}
    </div>
    
  </div>

  {# Phase 4.3: Force ALL theme fonts to load before Playwright/PDFShift captures.
     Each span references a font family; the browser fetches it to render the dot.
     Without this, some fonts may still be swapping when the PDF snapshot fires,
     causing fallback glyphs in the output.  The div is 1px outside the visible
     area so it has zero impact on layout. #}
  <div aria-hidden="true" style="position:absolute;left:-9999px;top:0;opacity:0;font-size:1px;line-height:1;pointer-events:none;">
    <span style="font-family:'Merriweather',serif">.</span>
    <span style="font-family:'Source Sans Pro',sans-serif">.</span>
    <span style="font-family:'Space Grotesk',sans-serif">.</span>
    <span style="font-family:'DM Sans',sans-serif">.</span>
    <span style="font-family:'Playfair Display',serif">.</span>
    <span style="font-family:'Montserrat',sans-serif">.</span>
    <span style="font-family:'Oswald',sans-serif">.</span>
    <span style="font-family:'Lato',sans-serif">.</span>
  </div>
</body>
</html>
