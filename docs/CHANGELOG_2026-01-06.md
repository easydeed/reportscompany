# Changelog - January 6, 2026

## V11 Email Enhancements

### Features

#### 1. Filter Description Blurb
For preset reports (First-Time Buyer, Luxury, Condo Watch, Investor Deals, Family Homes), emails now display a styled blurb immediately after the hero section explaining the applied filters.

**Example:**
```
┌─────────────────────────────────────────────────────────────────┐
│  Report Criteria: 2+ beds, 2+ baths, SFR, under $1,680,000     │
│                   (70% of Irvine median)                        │
└─────────────────────────────────────────────────────────────────┘
```

**Benefits:**
- Recipients understand what filters were applied
- Sets expectations for the listings they'll see
- Makes reports feel more personalized
- Only appears for preset reports (not "All Buyers" variants)

**Technical Implementation:**
- New `filter_description` parameter in `schedule_email_html()`
- Generated by `build_filters_label()` in `filter_resolver.py`
- Passed through: result → email_payload → template
- Files modified:
  - `apps/worker/src/worker/email/template.py`
  - `apps/worker/src/worker/email/send.py`
  - `apps/worker/src/worker/report_builders.py`
  - `apps/worker/src/worker/tasks.py`

#### 2. Closed Sales Table Priority
Previously, Closed Sales emails showed content in this order:
1. Hero metrics
2. Core indicators
3. Property types breakdown
4. Price tiers breakdown
5. **Listings table** ← Users had to scroll/click to see this!

This caused Gmail to clip the email (~102KB limit), requiring users to click "View entire message" multiple times.

**V11 Fix:** For closed sales, the order is now:
1. Hero metrics
2. **Listings table (top 10)** ← Immediately visible!
3. Quick take
4. CTA button

Property Types and Price Tiers are intentionally skipped for Closed Sales since the listings table is the primary content.

**Technical Implementation:**
- Conditional ordering in `template.py` based on `report_type == "closed"`
- No API changes required

### QA Verification

All 8 report configurations tested successfully:

| Report | Status | Notes |
|--------|--------|-------|
| ✅ Market Update | Completed | No filter blurb (no filters) |
| ✅ Closed Sales | Completed | Table now visible immediately |
| ✅ New Listings - All | Completed | No filter blurb (no filters) |
| ✅ New Listings - First-Time Buyers | Completed | Filter blurb shows "2+ beds, 2+ baths, SFR, under $X" |
| ✅ New Listings - Luxury | Completed | Filter blurb shows "SFR, over $X" |
| ✅ New Listings - Families | Completed | Filter blurb shows "3+ beds, 2+ baths, SFR" |
| ✅ New Listings - Condo | Completed | Filter blurb shows "Condos" |
| ✅ New Listings - Investors | Completed | Filter blurb shows "under $X" |

### Files Modified

```
apps/worker/src/worker/email/template.py   # V11 filter_description_html + closed sales ordering
apps/worker/src/worker/email/send.py       # Extract filter_description from payload
apps/worker/src/worker/report_builders.py  # Pass filters_label through result
apps/worker/src/worker/tasks.py            # Add filter_description to email_payload
docs/EMAIL_SYSTEM.md                       # Updated with V11 documentation
docs/QA_REPORTS_CHECKLIST.md               # Added V11 email checks
```

### Deployment

- **Render Worker Services:** Auto-deployed via Git push
- **All 3 workers live:** worker-service, consumer-bridge, ticker
- **Commit:** `92f645f` - "V11: Email enhancements - filter description blurb + closed sales table priority"

---

## V12 Gallery Metrics Fix + AI Insights

### Bug Fix: Gallery Email Metrics

**Problem:** Gallery email cards showed "0 Listings", "N/A", "N/A" instead of actual values.

**Root Cause:** The `build_new_listings_gallery_result()` function in `report_builders.py` returned listings but didn't calculate metrics. The email template expected a `metrics` dict with `total_listings`, `median_list_price`, and `min_price`.

**V12 Fix:** Added metrics calculation to gallery report builder:

```python
# Calculate metrics from ALL filtered listings (not just top 12 for display)
all_prices = [l.get("list_price") for l in new_listings if l.get("list_price")]

metrics = {
    "total_listings": len(new_listings),
    "median_list_price": sorted(all_prices)[len(all_prices) // 2] if all_prices else None,
    "min_price": min(all_prices) if all_prices else None,
    "max_price": max(all_prices) if all_prices else None,
    "avg_dom": sum(all_doms) / len(all_doms) if all_doms else None,
}
```

**Email Card Display After Fix:**
| Card | Before V12 | After V12 |
|------|-----------|-----------|
| New Listings | 0 | 102 |
| Median Price | N/A | $1.8M |
| Starting At | N/A | $615K |

### Enhancement: Gallery Listing Cap

- **Before V12:** Maximum 9 listings in gallery emails
- **After V12:** Maximum 12 listings (allows 4×3 grid layouts)

### Feature: AI-Powered Insights (Optional)

V12 introduces GPT-4o-mini integration for generating contextual market insight blurbs.

**Configuration:**
```bash
AI_INSIGHTS_ENABLED=true    # Enable AI insights (default: false)
OPENAI_API_KEY=sk-xxx       # Required if AI enabled
```

**Features:**
- Generates professional, market-aware insights
- Uses actual metrics in narrative
- Graceful fallback to template text if disabled/fails
- Cost-efficient: ~$0.001-0.002 per email

**Module:** `apps/worker/src/worker/ai_insights.py`

**Recommendation:** Keep AI disabled for launch. Enable for testing on your account, then offer as premium feature.

### QA Verification

Metrics now display correctly for all gallery reports:

| Report | Metrics Before | Metrics After |
|--------|---------------|---------------|
| ✅ New Listings - All | 0, N/A, N/A | 102, $1.8M, $615K |
| ✅ New Listings - First-Time | 0, N/A, N/A | Correct values |
| ✅ New Listings - Luxury | 0, N/A, N/A | Correct values |
| ✅ New Listings - Condo | 0, N/A, N/A | Correct values |
| ✅ New Listings - Family | 0, N/A, N/A | Correct values |
| ✅ New Listings - Investors | 0, N/A, N/A | Correct values |

### Files Modified

```
apps/worker/src/worker/report_builders.py  # V12 metrics calculation for gallery
apps/worker/src/worker/tasks.py            # Explicit total_listings for gallery emails
apps/worker/src/worker/email/template.py   # Gallery listing cap 9→12
apps/worker/src/worker/ai_insights.py      # NEW: GPT-4o-mini insight generation
docs/EMAIL_SYSTEM.md                       # V12 documentation (§2.7)
docs/QA_REPORTS_CHECKLIST.md               # V12 email checks
```

### Deployment

- **Render Worker Services:** Auto-deployed via Git push
- **Commit:** `ef3e7b0` - "V12: Email gallery enhancements + AI insights"

