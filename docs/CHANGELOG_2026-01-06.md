# Changelog - January 6, 2026

## V11 Email Enhancements

### Features

#### 1. Filter Description Blurb
For preset reports (First-Time Buyer, Luxury, Condo Watch, Investor Deals, Family Homes), emails now display a styled blurb immediately after the hero section explaining the applied filters.

**Example:**
```
┌─────────────────────────────────────────────────────────────────┐
│  Report Criteria: 2+ beds, 2+ baths, SFR, under $1,680,000     │
│                   (70% of Irvine median)                        │
└─────────────────────────────────────────────────────────────────┘
```

**Benefits:**
- Recipients understand what filters were applied
- Sets expectations for the listings they'll see
- Makes reports feel more personalized
- Only appears for preset reports (not "All Buyers" variants)

**Technical Implementation:**
- New `filter_description` parameter in `schedule_email_html()`
- Generated by `build_filters_label()` in `filter_resolver.py`
- Passed through: result → email_payload → template
- Files modified:
  - `apps/worker/src/worker/email/template.py`
  - `apps/worker/src/worker/email/send.py`
  - `apps/worker/src/worker/report_builders.py`
  - `apps/worker/src/worker/tasks.py`

#### 2. Closed Sales Table Priority
Previously, Closed Sales emails showed content in this order:
1. Hero metrics
2. Core indicators
3. Property types breakdown
4. Price tiers breakdown
5. **Listings table** ← Users had to scroll/click to see this!

This caused Gmail to clip the email (~102KB limit), requiring users to click "View entire message" multiple times.

**V11 Fix:** For closed sales, the order is now:
1. Hero metrics
2. **Listings table (top 10)** ← Immediately visible!
3. Quick take
4. CTA button

Property Types and Price Tiers are intentionally skipped for Closed Sales since the listings table is the primary content.

**Technical Implementation:**
- Conditional ordering in `template.py` based on `report_type == "closed"`
- No API changes required

### QA Verification

All 8 report configurations tested successfully:

| Report | Status | Notes |
|--------|--------|-------|
| ✅ Market Update | Completed | No filter blurb (no filters) |
| ✅ Closed Sales | Completed | Table now visible immediately |
| ✅ New Listings - All | Completed | No filter blurb (no filters) |
| ✅ New Listings - First-Time Buyers | Completed | Filter blurb shows "2+ beds, 2+ baths, SFR, under $X" |
| ✅ New Listings - Luxury | Completed | Filter blurb shows "SFR, over $X" |
| ✅ New Listings - Families | Completed | Filter blurb shows "3+ beds, 2+ baths, SFR" |
| ✅ New Listings - Condo | Completed | Filter blurb shows "Condos" |
| ✅ New Listings - Investors | Completed | Filter blurb shows "under $X" |

### Files Modified

```
apps/worker/src/worker/email/template.py   # V11 filter_description_html + closed sales ordering
apps/worker/src/worker/email/send.py       # Extract filter_description from payload
apps/worker/src/worker/report_builders.py  # Pass filters_label through result
apps/worker/src/worker/tasks.py            # Add filter_description to email_payload
docs/EMAIL_SYSTEM.md                       # Updated with V11 documentation
docs/QA_REPORTS_CHECKLIST.md               # Added V11 email checks
```

### Deployment

- **Render Worker Services:** Auto-deployed via Git push
- **All 3 workers live:** worker-service, consumer-bridge, ticker
- **Commit:** `92f645f` - "V11: Email enhancements - filter description blurb + closed sales table priority"

