# Consumer Report API (Mobile Viewer)

> Public endpoints for consumer report viewing, PDF generation, and analytics tracking.
> File: `apps/api/src/api/routes/mobile_reports.py`

## Endpoints

| Method | Path | Purpose | Auth |
|--------|------|---------|------|
| GET | /v1/r/{id}/data | Get report data as JSON | Public |
| POST | /v1/r/{id}/pdf | Generate/get PDF on demand | Public |
| GET | /v1/r/{id}/pdf/status | Poll for PDF readiness | Public |
| POST | /v1/r/{id}/analytics | Track user interactions | Public |

## Key Functions

### GET /v1/r/{id}/data
- Returns `MobileReportResponse` with:
  - `property`: PropertyData (address, beds, baths, sqft, tax info, coordinates)
  - `comparables`: List of Comparable (address, sold_price, sqft, distance, photo)
  - `value_estimate`: {low, mid, high, confidence}
  - `market_stats`: {median_price, avg_price_per_sqft, avg_days_on_market, price_trend}
  - `agent`: AgentInfo (name, phone, email, photo, company)
  - `has_pdf`: boolean
- JOINs consumer_reports with users for agent info
- Only returns reports with status in (ready, sent, processing, pending)
- Tracks page view in background task

### POST /v1/r/{id}/pdf
- Returns existing pdf_url if already generated
- Increments pdf_requested_count
- If no PDF: returns `{status: "generating"}` and queues via background task

### GET /v1/r/{id}/pdf/status
- Simple polling endpoint
- Returns `{status: "ready", pdf_url}` or `{status: "generating"}`

### POST /v1/r/{id}/analytics
- **Input:** `{event_type, event_data, session_id}`
- Event types: tab_change, agent_click, share, pdf_request
- Inserts into `report_analytics` table
- Special handling:
  - `agent_click`: Sets agent_contact_clicked=true on consumer_reports
  - `tab_change`: Appends tab name to tabs_viewed JSONB array

## Analytics Tracking

### View Tracking (background task)
- Increments view_count
- Sets first_viewed_at (only on first view)
- Updates last_viewed_at
- Records device_type
- Inserts into report_analytics table

### Device Detection
Simple user-agent parsing:
- Contains "mobile", "android", "iphone" -> `mobile`
- Contains "tablet", "ipad" -> `tablet`
- Default -> `desktop`

## Dependencies
- `db.py`: `db_conn()`, `fetchone_dict()`, `fetchall_dicts()`
- No external API calls -- data is pre-generated by the Worker

## Related Files
- Frontend: `/r/[id]` (public mobile report viewer page)
- Worker: `tasks.py: process_consumer_report()` generates the report data
